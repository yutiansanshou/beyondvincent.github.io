
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>破船之家</title>
	<meta name="author" content="破船(BeyondVincent)">

	
	<meta name="description" content="Apr 19th, 2013 iOS iOS中的唯一标示符 在2013年3月21日苹果已经通知开发者，从2013年5月1日起，访问UIDIDs的程序将不再被审核通过，替代的方案是开发者应该使用“在iOS 6中介绍的Vendor或Advertising标示符”。 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="破船之家" type="application/atom+xml">
	
	<link rel="canonical" href="http://BeyondVincent.github.io/blog/page/11/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		document.write("<img src='http://www.gravatar.com/avatar/" + MD5("beyondvincent@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
	</script>
</div>
<h1><a href="/">破船之家</a></h1>
<p class="subtitle">宠辱不惊，闲看庭前花开花落<br>去留无意，漫随天外云卷云舒<br>不妄取，不妄予，不妄想，不妄求<br>与人方便，随遇而安</p>
<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
  <li><a href="/about">关于我</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="weibo" href="http://www.weibo.com/beyondvincent" title="Weibo">Weibo</a>
		
		
		
		
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav></header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-19T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 19<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ios/'>iOS</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/19/12/" itemprop="url">iOS中的唯一标示符</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/ios_udid.png"><img class="alignnone size-full wp-image-400" alt="ios_udid" src="http://beyondvincent.com/wp-content/uploads/2013/04/ios_udid.png" width="976" height="313" /></a></p>

<p><strong>在2013年3月21日苹果已经通知开发者，从2013年5月1日起，<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://developer.apple.com/news/index.php?id=3212013a" target="_blank"><span style="color: #339966; text-decoration: underline;">访问UIDIDs的程序将不再被审核通过</span></a></span></span>，替代的方案是开发者应该使用“在iOS 6中介绍的Vendor或Advertising标示符”。</strong></p>

<p>苹果已经警告过我们<strong><span style="color: #339966;">uniqueIdentifier</span></strong>将不能再使用了，并且提供了另外两个可选的。但是在程序中该选择使用哪个呢？本文不会回答这个问题，具体用哪个是由你来根据程序的目的来做决定的。</p>

<p>下面我将列出iOS中目前支持的，以及被废弃的唯一标示符方法，并对其做出相应的解释，希望你看了以后针对唯一标示符的使用上，能够做出正确的确定。</p>

<h2><strong><span style="color: #339966;">CFUUID</span></strong></h2>

<p>从iOS2.0开始，CFUUID就已经出现了。它是CoreFoundatio包的一部分，因此API属于C语言风格。<strong><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://developer.apple.com/library/mac/documentation/CoreFoundation/Reference/CFUUIDRef/Reference/reference.html#//apple_ref/c/func/CFUUIDCreate"><span style="color: #339966; text-decoration: underline;">CFUUIDCreate</span></a></span></span></strong> 方法用来创建CFUUIDRef，并且可以获得一个相应的NSString，如下代码：</p>

<pre class="wp-code-highlight prettyprint linenums:1">CFUUIDRef cfuuid = CFUUIDCreate(kCFAllocatorDefault);
NSString *cfuuidString = (NSString*)CFBridgingRelease(CFUUIDCreateString(kCFAllocatorDefault, cfuuid));</pre>


<p>获得的这个CFUUID值系统并没有存储。每次调用CFUUIDCreate，系统都会返回一个新的唯一标示符。如果你希望存储这个标示符，那么需要自己将其存储到NSUserDefaults, Keychain, Pasteboard或其它地方。</p>

<p>示例: <strong><span style="color: #339966;">68753A44-4D6F-1226-9C60-0050E4C00067</span></strong></p>

<h2><strong><span style="color: #339966;">NSUUID</span></strong></h2>

<p><span style="text-decoration: underline;"><a href="http://developer.apple.com/library/ios/#documentation/Foundation/Reference/NSUUID_Class/Reference/Reference.html" target="_blank"><strong><span style="color: #339966; text-decoration: underline;">NSUUID</span></strong></a></span>在iOS 6中才出现，这跟CFUUID几乎完全一样，只不过它是Objective-C接口。<a href="http://developer.apple.com/library/ios/documentation/Foundation/Reference/NSUUID_Class/Reference/Reference.html#//apple_ref/occ/clm/NSUUID/UUID">+ (id)UUID</a> 是一个类方法，调用该方法可以获得一个UUID。通过下面的代码可以获得一个UUID字符串：</p>

<pre class="wp-code-highlight prettyprint linenums:1">NSString *uuid = [[NSUUID UUID] UUIDString];</pre>


<p>跟CFUUID一样，这个值系统也不会存储，每次调用的时候都会获得一个新的唯一标示符。如果要存储的话，你需要自己存储。在我读取NSUUID时，注意到获取到的这个值跟CFUUID完全一样（不过也可能不一样）：</p>

<p>示例: <span style="color: #339966;"><strong>68753A44-4D6F-1226-9C60-0050E4C00067</strong></span></p>

<h2><strong><span style="color: #339966;">广告标示符（IDFA-identifierForIdentifier）</span></strong></h2>

<p>这是iOS 6中另外一个新的方法，<strong><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://developer.apple.com/library/ios/documentation/AdSupport/Reference/ASIdentifierManager_Ref/ASIdentifierManager.html#//apple_ref/occ/instp/ASIdentifierManager/advertisingIdentifier"><span style="color: #339966; text-decoration: underline;">advertisingIdentifier</span></a></span></span></strong> 是新框架AdSupport.framework的一部分。ASIdentifierManager单例提供了一个方法advertisingIdentifier，通过调用该方法会返回一个上面提到的NSUUID实例。</p>

<pre class="wp-code-highlight prettyprint linenums:1">NSString *adId = [[[ASIdentifierManager sharedManager] advertisingIdentifier] UUIDString];</pre>


<p>跟CFUUID和NSUUID不一样，广告标示符是由系统存储着的。不过即使这是由系统存储的，但是有几种情况下，会重新生成广告标示符。如果用户完全重置系统（(设置程序 &ndash;> 通用 &ndash;> 还原 &ndash;> 还原位置与隐私) ，这个广告标示符会重新生成。另外如果用户明确的还原广告(设置程序-> 通用 &ndash;> 关于本机 &ndash;> 广告 &ndash;> 还原广告标示符) ，那么广告标示符也会重新生成。关于广告标示符的还原，有一点需要注意：如果程序在后台运行，此时用户“还原广告标示符”，然后再回到程序中，此时获取广告标示符并不会立即获得还原后的标示符。必须要终止程序，然后再重新启动程序，才能获得还原后的广告标示符。之所以会这样，我猜测是由于ASIdentifierManager是一个单例。</p>

<p>针对广告标示符用户有一个可控的开关“限制广告跟踪”。Nick Arnott的<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://www.doubleencore.com/2013/04/what-apples-limit-ad-tracking-feature-actually-means-to-users/" target="_blank"><span style="color: #339966; text-decoration: underline;">文章中已经指出了</span></a></span></span>。将这个开关打开，实际上什么也没有做，不过这是希望限制你访问广告标示符。这个开关是一个简单的boolean标志，当将广告标示符发到任意的服务器端时，你最好判断一下这个值，然后再做决定。</p>

<p>示例: <strong><span style="color: #339966;">1E2DFA89-496A-47FD-9941-DF1FC4E6484A</span></strong></p>

<h2><strong><span style="color: #339966;">Vindor标示符 (</span><span style="text-decoration: underline; color: #339966;"><span style="text-decoration: underline;"><a href="https://developer.apple.com/library/ios/documentation/uikit/reference/UIDevice_Class/Reference/UIDevice.html#//apple_ref/occ/instp/UIDevice/identifierForVendor"><span style="color: #339966; text-decoration: underline;">IDFV</span></a></span></span><span style="text-decoration: underline; color: #339966;"><span style="color: #339966; text-decoration: underline;">-identifierForVendor</span></span><span style="color: #339966;">)</span></strong></h2>

<p>这种叫法也是在iOS 6中新增的，不过获取这个IDFV的新方法被添加在已有的UIDevice类中。跟advertisingIdentifier一样，该方法返回的是一个NSUUID对象。</p>

<pre class="wp-code-highlight prettyprint linenums:1">NSString *idfv = [[[UIDevice currentDevice] identifierForVendor] UUIDString];</pre>


<p>苹果官方的文档中对identifierForVendor有如下这样的一段描述 ：</p>

<p><em><span style="color: #999999;">The value of this property is the same for apps that come from the same vendor running on the same device. A different value is returned for apps on the same device that come from different vendors, and for apps on different devices regardless of vendor.</span></em></p>

<p><em><span style="color: #999999;">如果满足这样的条件，那么获取到的这个属性值就不会变：相同的一个程序里面-相同的vindor-相同的设备。如果是这样的情况，那么这个值是不会相同的：相同的程序-相同的设备-不同的vindor，或者是相同的程序-不同的设备-无论是否相同的vindor。</span></em></p>

<p>看完上面的内容，我有这样的一个疑问“vendor是什么”。我首先想到的是苹果开发者账号。但事实证明这是错误的。接着我想可能是有一个AppIdentifierPrefix东西，跟钥匙串访问一样，可以在多个程序间共享。同样，这个想法也是的。最后证明，vendor非常简单：一个Vendor是CFBundleIdentifier（反转DNS格式）的前两部分。例如，<strong><span style="color: #339966;">com.doubleencore.app1</span></strong> 和 <strong><span style="color: #339966;">com.doubleencore.app2</span></strong> 得到的identifierForVendor是相同的，因为它们的CFBundleIdentifier 前两部分是相同的。不过这样获得的identifierForVendor则完全不同：<span style="color: #339966;"><strong>com.massivelyoverrated</strong></span> 或 <strong><span style="color: #339966;">net.doubleencore</span></strong>。</p>

<p>在这里，还需要注意的一点就是：如果用户卸载了同一个vendor对应的所有程序，然后在重新安装同一个vendor提供的程序，此时identifierForVendor会被重置。</p>

<p>示例: <strong><span style="color: #339966;">599F9C00-92DC-4B5C-9464-7971F01F8370</span></strong></p>

<p><strong style="font-size: 1.5em;"><span style="color: #339966;">UDID</span></strong></p>

<p>在之前的版本中是可用的，但是在iOS5以及之后的版本中，以及被弃用了。虽然，这个UDID用得很广泛，但是，不得不说的是，它在慢慢的远离开发者，不能在考虑使用UDID了。至于这个标示符是转为私有方法，或者完全从以后的iOS版本中移除，还有待观察。不过，这个UDID在部署企业级签名程序时，非常方便。获取UDID的方法如下：</p>

<pre class="wp-code-highlight prettyprint linenums:1">NSString *udid = [[UIDevice currentDevice] uniqueIdentifier];</pre>


<p>示例: <strong><span style="color: #339966;">bb4d786633053a0b9c0da20d54ea7e38e8776da4</span></strong></p>

<h2><strong><span style="color: #339966;">OpenUDID</span></strong></h2>

<p>在iOS 5发布时，uniqueIdentifier被弃用了，这引起了广大开发者需要寻找一个可以替代UDID，并且不受苹果控制的方案。由此<strong><span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://github.com/ylechelle/OpenUDID" target="_blank"><span style="color: #339966; text-decoration: underline;">OpenUDID</span></a></span></span></strong>成为了当时使用最广泛的开源UDID替代方案。OpenUDID在工程中实现起来非常简单，并且还支持一系列的广告提供商。</p>

<pre class="wp-code-highlight prettyprint linenums:1">NSString *openUDID = [OpenUDID value];</pre>


<p>OpenUDID利用了一个非常巧妙的方法在不同程序间存储标示符 — 在粘贴板中用了一个特殊的名称来存储标示符。通过这种方法，别的程序（同样使用了OpenUDID）知道去什么地方获取已经生成的标示符（而不用再生成一个新的）。</p>

<p>之前已经提到过，在将来，苹果将开始强制使用advertisingIdentifier 或identifierForVendor。如果这一天到来的话，即使OpenUDID看起来是非常不错的选择，但是你可能不得不过渡到苹果推出的方法。</p>

<p>示例: <strong><span style="color: #339966;">0d943976b24c85900c764dd9f75ce054dc5986ff</span></strong></p>

<h2><strong><span style="color: #339966;">总结</span></strong></h2>

<p>希望上面的信息能够帮助你在程序使用选择正确的唯一标示符。在这里，我创建了一个<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://github.com/doubleencore/DEUID" target="_blank"><span style="color: #339966; text-decoration: underline;">小的唯一标示符测试程序</span></a></span></span>，你可以运行该程序，并查看一下显示的内容（包括上面提到的所有标示符）。另外，下面有两个表，表中描述了两个内容：在iOS中的可用性，以及什么时候可以获得重置的标示符。</p>

<p><a href="http://www.doubleencore.com/wp-content/uploads/2013/04/Screen-Shot-2013-04-09-at-12.21.16-PM1.png"><img class="alignnone" alt="" src="http://www.doubleencore.com/wp-content/uploads/2013/04/Screen-Shot-2013-04-09-at-12.21.16-PM1.png" width="1035" height="616" /></a></p>

<ul>
<li>程序必须重启才能看到改变的效果。</li>
</ul>


<p>** 删除了所有相同vendor提供的程序，才能看到改变的值。</p>

<p>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_____</p>

<p>本文由破船译自：<span style="text-decoration: underline;"><strong><span style="color: #339966;"><a href="http://www.doubleencore.com/2013/04/unique-identifiers/" target="_blank"><span style="color: #339966; text-decoration: underline;">doubleencore</span></a></span></strong></span><br/>
转载请注明出处：<strong><span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://www.beyondvincent.com/" target="_blank"><span style="color: #339966; text-decoration: underline;">BeyondVincent的博客</span></a></span></span></strong><br/>
_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_____</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-19T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 19<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/qi-ta/'>其它</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/19/11/" itemprop="url">浅谈中国革命战争的战略问题与诺基亚和苹果的发展</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<ol>
<li>简介</li>
<li><em>2007</em>年前<em>(</em>诺基亚的强大<em>VS</em>苹果的弱小<em>) </em></li>
<li><em>2007</em>年后<em>(</em>战局的转变<em>) </em></li>
<li><p>反思</p></li>
<li><p><strong style="font-size: 1.5em;"><span style="color: #339966;">简介</span></strong></p></li>
</ol>


<p>最近阅读了毛泽东在1936提出的《<span style="text-decoration: underline;"><a href="http://baike.baidu.com/view/125687.htm" target="_blank"><strong><span style="color: #339966; text-decoration: underline;">中国革命战争的战略问题</span></strong></a></span>》（本文以 后简称“<span style="color: #339966;"><strong>战略问题</strong></span>”）。<strong><span style="color: #339966;">战略问题</span></strong>是为了总结第二次国<a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130419-1.png"><img class="alignright size-medium wp-image-376" alt="QQ20130419-1" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130419-1-300x224.png" width="300" height="224" /></a>内革命战争的经验而写的。</p>

<p>从文中，能够感觉到毛泽东对当时的战争形势有充分的了解，特别是敌我双方的情况，以及如何把握战局才能赢得整个战争。其中以下几点尤为突出：</p>

<ul>
<li>认识到敌强我弱。无论是在政治上还是经济上，当时的共产党无</li>
<li>法与敌对方抗衡。敌对方在政治上和经济上获得了资本主义国家的大力支持，特别是军事力量上，特别的强大。反观共产党，在军事力量上，军工业基本为零，基本没有稳定的补给来源。</li>
<li>知道战争的成功离不开农民。毛泽东非常清楚当时的战局情形，共产党在政治和经济上没有优势，唯有利用好农民，并在农村建立根据地，才能获得战争上的最大优势。</li>
<li>需要持久作战，与敌长期周旋。由于敌对方势力过于强大，共产党不可能再短期内获得战争的胜利。只有长期持久作战，集中自己的优势，打击敌人的劣势。</li>
<li>保存生命军，不断扩大增强。由于当时共产党的实力比较弱，需要保存好自己的生命军，并在与敌人长期周旋的过程中，逐渐发展壮大自身，以逐渐扭转战局的劣势，并获得最终的胜利。</li>
</ul>


<p>以上特点是共产党在当时战局中的自身特点，以及需要执行的一些战略。 我们反观近些年来移动互联网行业诺基亚与苹果在手机方面的发展史，无疑不是一部精彩的战争史。</p>

<ol start="2">
  <li>
    <h2>
      <strong><span style="color: #339966;">2007年前(诺基亚的强大VS苹果的弱小) </span></strong>
    </h2>
  </li>
</ol>


<p>在2007前，诺基亚无疑是手机行业中的大哥大。当时无论是摩托罗拉，索爱等手机厂商都无法与诺基亚抗衡，更不用提苹果了。无<a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130419-4.png"><img class="alignright size-medium wp-image-377" alt="QQ20130419-4" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130419-4-300x220.png" width="300" height="220" /></a>论是功能机还是智能机，诺基亚在全球都是霸主地位。可以说，提到手机，就想到诺基亚。</p>

<p>在诺基亚辉煌的时候，给手机换个壳子，或者颜色，就能带来丰厚的收入。当然，诺基亚手机的质量是无可挑剔的。但是诺基亚在取得伟大胜利的时候，并没有继续前行，开发出用户体验更好的手机，而是继续生产销售着没有任何革命性改变的产品。</p>

<p>而诺基亚手机在大众面前如日冲天的时候，苹果在手机上可以说为0。但是，苹果当时的CEO乔布斯，在2007年前，已经认识到用户对智能机的强烈需求，</p>

<p>并且对当下智能机的用户体验非常不满，发现智能机在未来有非常大的市场。但是，由于当时诺基亚的强大，致使苹果必须采取特殊的战略（战略稍后会有介绍），才能在智能机这块大蛋糕上获得丰厚的利润。</p>

<ol start="3">
  <li>
    <strong style="font-size: 1.5em;"><span style="color: #339966;">2007年后(战局的转变)</span></strong>
  </li>
</ol>


<p>为了能在智能机上获得丰厚的利润，早在2007年前就展开了iPhone的研发，并且在2007年1月成功发布了iPhone第一代，在手机行<a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130419-3.png"><img class="alignright size-medium wp-image-378" alt="QQ20130419-3" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130419-3-300x266.png" width="300" height="266" /></a>业展开了真正的竞争。经过5年的发展(至今2013年)，苹果目前无疑是手机行业的老大，而诺基亚犹如5年前的苹果，已经在没落。 下面我们来看看在这五年当中，苹果是如何一步一步的将诺基亚踢下神坛，并稳居宝座。</p>

<p>首先，在2007年时，苹果认识到自己的实力，无论在手机产品研发方面还是用户市场占有率上，都不足以与诺基亚抗衡。但是苹果嗅觉到了一个重要的东西：移动互联网：随着移动互联网的快速发展，当时的功能机越来越无法满足用户的需求（不仅仅是打电话和发短信了）。并且，当时的手机只注重功能，而很少从用户体验的角度来考虑。为此，用户正迫切需要具有革命性的一款或一类手机出来——姑且可以称为移动互联网手机。当时，在这方面，诺基亚是不占据优势的，或者可以说不具有苹果这样的前瞻性。苹果以此为切入点，开发并发布了iPhone手机。</p>

<p>其次，苹果的成功离不开开发者。在移动互联网时代，智能手机要想获得用户的青睐，必须拥有各种各样的程序，以满足用户的多样化需求，而程序的开发不可能完全由苹果的工程师来完成，这必须借助于第三方开发者。苹果在起初就已经已经对此有预见了，那么怎样才能让开发者愿意为iPhone开发程序呢——这是一个非常关键的问题。苹果通过应用商店(AppStore)成功解决了这个难题。通过应用商店，开发者可以开发并销售自己的iPhone程序，以获得利益，这不仅可以调动开发者的积极性，同时，还可以从开发者销售的软件中获得利益分成。AppStore可以理解为苹果赖以生存的根据地。为此，苹果也打造出了一个发展良性的生态圈。</p>

<p>再者，苹果依据iPhone的成功，一步一步的转变与诺基亚之间的战局。苹果为了让成功的战火延续下去，至少一直在做着下面两件事情：</p>

<ul>
<li>不断加强产品的研发能力，以提供更好的用户体验。</li>
<li>不断扩充自己的产品库（iPhone，iPad，mini-iPad），以渗入到更深，更广的用户群（满足不同人群的不同需求）。</li>
<li>不断与同行间竞争，无论是专利的维护，还是市场店面的扩张，苹果都一直马不停蹄。</li>
</ul>


<p>而在苹果快速扭转战局的5年当中，我们再来看看诺基亚的情况：</p>

<p>首先，在苹果刚刚发布出iPhone时，诺基亚对这款产品不屑一提，依旧我行我素的走自己的路。从中，我们可以看出，诺基亚低估了对手的实力，同时也缺乏市场的敏锐嗅觉力（或许这与诺基亚内部的官僚主义有关）。</p>

<p>其次，当苹果在市场上取得了一定成绩之后，诺基亚似乎感觉到点什么，在2008年的10月份才推出自己的首款全触屏手机（5800）。但是，这并没有抓住渐行渐远的消费者的心。诺基亚慢慢的感觉到了问题的严重性，从Symbian操作系统，到Meego操作系统的选择，再到与微软携手Windows Phone，从全球性的裁员到出卖办公大楼，这无不体现出诺基亚的没落——犹如即将沉入大海的泰坦尼克号。</p>

<p>从苹果的辉煌与诺基亚的没落中，我们可以看到这犹如一场战争，只有清楚的认识自己与当下的时局，并对未来有远见，然后一步一步，稳扎稳打的，才能在战场上有获胜的把握。</p>

<ol start="4">
  <li>
    <h2>
      <strong><span style="color: #339966;">反思</span></strong>
    </h2>
  </li>
</ol>


<p>上面只是发表了一下我对诺基亚与苹果之间的发展的一些看法。实际上，犹如毛泽东在《战略问题》中提到的，要想在战争中取得<br/>
胜利，需要考虑方方面面的因素（敌我情况，我方补给、阵地利弊等）。同样，在移动互联网行业，不仅有诺基亚和苹果在竞争，另外还有三星，摩托罗拉，HTC，华为，小米等手机厂商之间，都在大力的展开角逐，希望在手机行业，乃至移动互联网中分得一杯羹。最终的结果是某个手机厂商一家独大，还是三足鼎立呢？</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/mobile-fire.png"><img class="alignnone size-full wp-image-445" alt="mobile-fire" src="http://beyondvincent.com/wp-content/uploads/2013/04/mobile-fire.png" width="976" height="313" /></a></p>

<p style="text-align: right;">
  <span style="color: #c0c0c0;">破船撰于2013.04.18</span>
</p>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-18T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 18<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ios/'>iOS</a>, <a class='category' href='/blog/categories/ioskai-fa-ji-lu/'>iOS开发记录</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/18/10/" itemprop="url">在Xcode4.6中如何将xib for iPhone的文件转换为for iPad</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2><strong><span style="color: #339966;">在Xcode4.6中将xib for iPhone的文件转换为for iPad</span></strong></h2>

<p>有时候你已经开发了iPhone项目，但是没有针对iPad开发，现在需要iPhone程序也能iPad上很好的运行，那么直接将之前的项目拿过来进行改造，是最好的。本文的内容对你或许有用。<a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130418-2.png"><img class="alignright size-medium wp-image-372" alt="QQ20130418-2" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130418-2-300x162.png" width="300" height="162" /></a></p>

<h2><strong><span style="color: #339966;">我的操作步骤如下：</span></strong></h2>

<ol>
<li>在Xcode中选中要转换的xib文件，然后选择File->Duplicate，复制一份xib文件。</li>
<li>在新复制出来的这个xib文件上，右键单击->Open As->Source Code。</li>
<li>将打开源码文件中&#8221;com.apple.InterfaceBuilder3.CocoaTouch.XIB&#8221;替换为&#8221;com.apple.InterfaceBuilder3.CocoaTouch.iPad.XIB&#8221;。</li>
<li>将所有的&#8221;IBCocoaTouchFramework&#8221;替换为&#8221;IBIPadFramework&#8221;</li>
<li>保存并关闭Source Code，重新将这个xib文件用IB打开（选中xib文件，右键单击->Open As->Interface Builder &#8211; iOS）</li>
<li>选中针对这个xib文件的main viewcontroller或者UIView，然后打开attributes inspector(在xcode的右边)，在Size里面选择“iPad Full Screen”。就可以根据自己的设计来调整UI界面了。</li>
</ol>


<p>如果需要将iPad的xib文件转换为iPhone的，那么反过来操作3和4步骤中的内容也同样可以。</p>

<p>关于xib文件的转换，如果你有任何问题或者更好的办法，请留言告诉我！:]</p>

<p>本文参考了stackoverflow上面的一个QA：<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://stackoverflow.com/questions/5347198/xcode-4-xib-create-ipad-version" target="_blank"><span style="color: #339966; text-decoration: underline;">Xcode 4 .xib Create iPad Version</span></a></span></span></p>

<p style="text-align: right;">
  <span style="color: #c0c0c0;">破船撰写于@2013.04.18</span>
</p>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-17T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 17<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ios/'>iOS</a>, <a class='category' href='/blog/categories/raywenderlichfan-yi/'>raywenderlich翻译</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/17/8/" itemprop="url">iOS中如何创建一个滑出式导航面板(2)</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_____</p>

<p>本文由破船译自：<a href="http://www.raywenderlich.com/32054/how-to-create-a-slide-out-navigation-like-facebook-and-path" target="_blank">raywenderlich</a><br/>
转载请注明出处：<a href="http://www.beyondvincent.com/" target="_blank">BeyondVincent的博客</a><br/>
_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_____</p>

<p>接着上一篇<a href="http://beyondvincent.com/2013/04/16/ios%E4%B8%AD%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%BB%91%E5%87%BA%E5%BC%8F%E5%AF%BC%E8%88%AA%E9%9D%A2%E6%9D%BF1/" target="_blank"><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;">如何创建一个滑出式导航面板(1)</span></span></a></p>

<h2><strong><span style="color: #339966;">现在靠向右边</span></strong></h2>

<p>在<strong><span style="color: #339966;">MainViewController.m</span></strong>文件中，将下面的import语句添加到文件顶部：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import "RightPanelViewController.h"</pre>


<p>然后添加下面的常量定义：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#define RIGHT_PANEL_TAG 3</pre>


<p>接着在@interface里面添加如下属性，这样就容易获取到right view和它的当前状态：</p>

<pre class="wp-code-highlight prettyprint linenums:1">@property (nonatomic, strong) RightPanelViewController *rightPanelViewController;
@property (nonatomic, assign) BOOL showingRightPanel;</pre>


<p>然后是找到<strong><span style="color: #339966;">getRightView</span></strong>方法，并移除里面已有的代码，然后添加下面的代码进去：</p>

<pre class="wp-code-highlight prettyprint linenums:1">// init view if it doesn&#039;t already exist
if (_rightPanelViewController == nil)
{
    // this is where you define the view for the right panel
    self.rightPanelViewController = [[RightPanelViewController alloc] initWithNibName:@"RightPanelViewController" bundle:nil];
    self.rightPanelViewController.view.tag = RIGHT_PANEL_TAG;
    self.rightPanelViewController.delegate = _centerViewController;

    [self.view addSubview:self.rightPanelViewController.view];

    [self addChildViewController:self.rightPanelViewController];
    [_rightPanelViewController didMoveToParentViewController:self];

    _rightPanelViewController.view.frame = CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height);
}

self.showingRightPanel = YES;

// set up view shadows
[self showCenterViewWithShadow:YES withOffset:2];

UIView *view = self.rightPanelViewController.view;
return view;</pre>


<p>上面的代码是拷贝getLeftView的，只不过其中的类和属性不同而已。如果对上面的代码有任何疑问，可以回头看看之前的解释。</p>

<p>跟之前的一样，在xib文件中已经连接好了相关的IBAction和IBOutlet。下面是CenterViewController.xib文件的一个截图，显示出了puppies按钮的连接关系：</p>

<p><a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/02/xcodeRightButtonSetup.png"><img class="alignnone" alt="" src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/02/xcodeRightButtonSetup.png" width="700" height="626" /></a></p>

<p>如上图所示，跟kitties按钮类似，puppies按钮连接到的IBOutlet是rightButton，IBAction是btnMovePanelLeft:。这个按钮控制着center panel的滑动以显示出右边的panel。</p>

<p>下面我们就来让panel移动起来吧。</p>

<p>打开<strong><span style="color: #339966;">CenterController.m</span></strong>文件，并将下面的代码添加到<strong><span style="color: #339966;">btnMovePanelLeft:</span></strong>中：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIButton *button = sender;    
switch (button.tag) {
    case 0: {
        [_delegate movePanelToOriginalPosition];
        break;
    }

    case 1: {
        [_delegate movePanelLeft];
        break;
    }

    default:
        break;
}</pre>


<p>同样，上面的代码与btnMovePanelRight:方法的实现没有什么不同。可以看到delegate的调用方法几乎是一样的。</p>

<p>因为之前已经实现了movePanelToOriginalPostion方法，所以剩下的任务只需要添加movePanelLeft 方法，并修改一下resetMainView以处理right panel即可。</p>

<p>&nbsp;</p>

<h2><span style="color: #339966;"><strong>将右边显示出来</strong></span></h2>

<p>打开<strong><span style="color: #339966;">MainViewController.m</span></strong>文件，并将下面的代码添加到<strong><span style="color: #339966;">movePanelLeft:</span></strong>方法中：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIView *childView = [self getRightView];
[self.view sendSubviewToBack:childView];

[UIView animateWithDuration:SLIDE_TIMING delay:0 options:UIViewAnimationOptionBeginFromCurrentState
                animations:^{
                    _centerViewController.view.frame = CGRectMake(-self.view.frame.size.width + PANEL_WIDTH, 0, self.view.frame.size.width, self.view.frame.size.height);
                }
                completion:^(BOOL finished) {
                    if (finished) {

                        _centerViewController.rightButton.tag = 0;
                    }
                }];</pre>


<p>上面的代码与movePanelRight方法中的基本相同，这里就不再做过多的解释。</p>

<p>接着找到<strong><span style="color: #339966;">resetMainView</span></strong>方法，并用下面的代码替换已有的内容：</p>

<pre class="wp-code-highlight prettyprint linenums:1">// remove left and right views, and reset variables, if needed
if (_leftPanelViewController != nil)
{
    [self.leftPanelViewController.view removeFromSuperview];
    self.leftPanelViewController = nil;

    _centerViewController.leftButton.tag = 1;
    self.showingLeftPanel = NO;
}

if (_rightPanelViewController != nil)
{
    [self.rightPanelViewController.view removeFromSuperview];
    self.rightPanelViewController = nil;

    _centerViewController.rightButton.tag = 1;
    self.showingRightPanel = NO;
}

// remove view shadows
[self showCenterViewWithShadow:NO withOffset:0];</pre>


<p>上面代码中唯一修改的地方是增加了一个if语句代码块：if(_rightPanelViewController != nil)。该语句判断一下right panel view是否存在，这跟之前检查left panel view一样，并且对_rightPanelViewController做相同的处理！</p>

<p>现在编译并运行程序，点击puppies按钮，将看到如下画面：</p>

<p><a href="http://cdn5.raywenderlich.com/wp-content/uploads/2013/02/simRightReveal-333x500.png"><img class="alignnone" alt="" src="http://cdn5.raywenderlich.com/wp-content/uploads/2013/02/simRightReveal-333x500.png" width="333" height="500" /></a></p>

<p>看起来不错吧？</p>

<p>在下面一节中，将介绍如何添加手势功能。</p>

<h2><strong><span style="color: #339966;">来回移动你的手指</span></strong></h2>

<p>在程序中添加手势处理非常简单，不要以为太复杂，很容易就能实现的！</p>

<p><a href="http://cdn3.raywenderlich.com/wp-content/uploads/2013/03/grooveinthehandsc-480x177.png"><img class="alignnone" alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/03/grooveinthehandsc-480x177.png" width="480" height="177" /></a></p>

<p>还是在<strong><span style="color: #339966;">MainViewController.m</span></strong>文件中，找到<strong><span style="color: #339966;">setupView</span></strong>方法，并在方法的尾部添加如下一行代码：</p>

<pre class="wp-code-highlight prettyprint linenums:1">[self setupGestures];</pre>


<p>接着，需要让MainViewController遵循UIGestureRecognizerDelegate协议——将UIGestureRecognizerDelegate添加到文件顶部的@interface中，添加后的代码如下：</p>

<pre class="wp-code-highlight prettyprint linenums:1">@interface MainViewController ()&lt;UIGestureRecognizerDelegate, CenterViewControllerDelegate&gt;</pre>


<p>最后，找到<span style="color: #339966;"><strong>setupGestures</strong></span>方法，并将下面的代码块添加进去：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIPanGestureRecognizer *panRecognizer = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(movePanel:)];
[panRecognizer setMinimumNumberOfTouches:1];
[panRecognizer setMaximumNumberOfTouches:1];
[panRecognizer setDelegate:self];

[_centerViewController.view addGestureRecognizer:panRecognizer];</pre>


<p>上面的代码定义了一个UIPanGestureRecognizer，并将movePanel:方法赋值给它，当有检测到手势时，就会调用这个方法。（稍后需要实现movePanel:方法。）</p>

<p>接着，配置一下panRecognizer：将触摸的最大数目和最小数目设置为1，另外还设置了一下delegate。最后，将刚刚创建好的panRecognizer添加到_centerViewController.view中。</p>

<p><strong>注意</strong>：更多关于UIGestureRecognizer类的信息, 请参考<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://developer.apple.com/library/ios/#documentation/uikit/reference/UIGestureRecognizer_Class/Reference/Reference.html" target="_blank"><span style="color: #339966; text-decoration: underline;">苹果官方文档</span></a></span></span>。</p>

<p>接着，再做一件事情就可以用手势进行滑动了。</p>

<h2><strong><span style="color: #339966;">现在就来移动View吧</span></strong></h2>

<p>当识别到手势之后会调用movePanel:方法。所以，本文最后一个任务就是来实现一下这个方法。</p>

<p>movePanel:方法使用到两个属性：showPanel 和 preVelocity。在<strong><span style="color: #339966;">MainViewController.m</span></strong>文件的@interface中添加上这两个属性：</p>

<pre class="wp-code-highlight prettyprint linenums:1">@property (nonatomic, assign) BOOL showPanel;
@property (nonatomic, assign) CGPoint preVelocity;</pre>


<p>找到<em>movePanel:</em> 并将下面这段代码添加进去（很多哦！）：</p>

<pre class="wp-code-highlight prettyprint linenums:1">[[[(UITapGestureRecognizer*)sender view] layer] removeAllAnimations];

CGPoint translatedPoint = [(UIPanGestureRecognizer*)sender translationInView:self.view];
CGPoint velocity = [(UIPanGestureRecognizer*)sender velocityInView:[sender view]];

if([(UIPanGestureRecognizer*)sender state] == UIGestureRecognizerStateBegan) {
        UIView *childView = nil;

        if(velocity.x &gt; 0) {
            if (!_showingRightPanel) {
                childView = [self getLeftView];
            }
        } else {
            if (!_showingLeftPanel) {
                childView = [self getRightView];
            }

        }
        // Make sure the view you&#039;re working with is front and center.
        [self.view sendSubviewToBack:childView];
        [[sender view] bringSubviewToFront:[(UIPanGestureRecognizer*)sender view]];
}

if([(UIPanGestureRecognizer*)sender state] == UIGestureRecognizerStateEnded) {

        if(velocity.x &gt; 0) {
            // NSLog(@"gesture went right");
        } else {
            // NSLog(@"gesture went left");
        }

        if (!_showPanel) {
            [self movePanelToOriginalPosition];
        } else {
            if (_showingLeftPanel) {
                [self movePanelRight];
            }  else if (_showingRightPanel) {
                [self movePanelLeft];
            }
        }
}

if([(UIPanGestureRecognizer*)sender state] == UIGestureRecognizerStateChanged) {
        if(velocity.x &gt; 0) {
            // NSLog(@"gesture went right");
        } else {
            // NSLog(@"gesture went left");
        }

        // Are you more than halfway? If so, show the panel when done dragging by setting this value to YES (1).
        _showPanel = abs([sender view].center.x - _centerViewController.view.frame.size.width/2) &gt; _centerViewController.view.frame.size.width/2;

        // Allow dragging only in x-coordinates by only updating the x-coordinate with translation position.
        [sender view].center = CGPointMake([sender view].center.x + translatedPoint.x, [sender view].center.y);
        [(UIPanGestureRecognizer*)sender setTranslation:CGPointMake(0,0) inView:self.view];

        // If you needed to check for a change in direction, you could use this code to do so.
        if(velocity.x*_preVelocity.x + velocity.y*_preVelocity.y &gt; 0) {
            // NSLog(@"same direction");
        } else {
            // NSLog(@"opposite direction");
        }

        _preVelocity = velocity;
}</pre>


<p>上面代码中的注视已经有对功能做了不错的解释。下面是一些需要明白的关键信息：</p>

<ul>
<li>需要处理3个状态：UIGestureRecognizerStateBegan, UIGestureRecognizerStateEnded和 UIGestureRecognizerStateChanged。</li>
<li>translationInView：返回某个位置在指定view的坐标系中的point，并将这个point赋值给translatedPoint变量, 该变量用来设置view的位置。</li>
<li>velocityInView: 返回每秒钟手势的移动速率。该变量有助于确定方向的改变。</li>
</ul>


<p>你可以移动center，left和right view，并结合上面提到的3个状态，就可以确定手势的位置和速率/方向。</p>

<p>例如，如果手势方向是向右的，那么就显示出left panel。如果方向是向左，则显示出right panel。通过查看代码和相关的注释，就可以知道每一种状态都发生了什么。</p>

<p>再次编译并运行程序。现在应该可以把center panel滑动到左边或者右边了，并显示出center panel下面的panel。</p>

<p><a href="http://cdn3.raywenderlich.com/wp-content/uploads/2013/02/simLeftReveal-333x500.png"><img class="alignnone" alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/02/simLeftReveal-333x500.png" width="333" height="500" /></a> <a href="http://cdn5.raywenderlich.com/wp-content/uploads/2013/02/simRightReveal-333x500.png"><img class="alignnone" alt="" src="http://cdn5.raywenderlich.com/wp-content/uploads/2013/02/simRightReveal-333x500.png" width="333" height="500" /></a></p>

<h2><strong><span style="color: #339966;">何去何从</span></strong></h2>

<p>如果你完全按照本文介绍的方法来操作，那么恭喜你，你已经成为一名滑出式导航面板忍者了！</p>

<p><a href="http://cdn2.raywenderlich.com/wp-content/uploads/2013/03/feel-like-a-ninja.jpg"><img class="alignnone" alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/03/feel-like-a-ninja.jpg" width="300" height="247" /></a></p>

<p>希望本文对你有用！这里是本文涉及到的完整示例工程：<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://cdn5.raywenderlich.com/downloads/SlideOutNavigationFinal.zip"><span style="color: #339966; text-decoration: underline;">completed project file</span></a></span></span>。</p>

<p>之前我提到过，如果你更喜欢已经定义好了的库，而不是DIY，那么请看<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a title="SWRevealViewController" href="https://github.com/John-Lluch/SWRevealViewController" target="_blank"><span style="color: #339966; text-decoration: underline;">SWRevealViewController</span></a>.</span></span> 看看这里的<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://github.com/John-Lluch/SWRevealViewController#usage" target="_blank"><span style="color: #339966; text-decoration: underline;">开发者相关介绍</span></a></span></span>，很容易就能使用它了。</p>

<p style="text-align: right;">
  <span style="color: #c0c0c0;">全文完毕！ 破船翻译于2013.04.17</span>
</p>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-16T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 16<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/raywenderlichfan-yi/'>raywenderlich翻译</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/16/8/" itemprop="url">iOS中如何创建一个滑出式导航面板(1)</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_____</p>

<p>本文由破船译自：<a href="http://www.raywenderlich.com/32054/how-to-create-a-slide-out-navigation-like-facebook-and-path" target="_blank">raywenderlich</a><br/>
转载请注明出处：<a href="http://www.beyondvincent.com/" target="_blank">BeyondVincent的博客</a><br/>
_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_____</p>

<p>本文将介绍如何创建类似Facebook和Path iOS程序中的滑出式导航面板。</p>

<div class="wp-caption alignright" style="width: 223px">
  <a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/02/fbMidSlide-213x320.png"><img alt="" src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/02/fbMidSlide-213x320.png" width="213" height="320" /></a><p class="wp-caption-text">
    向右滑动
  </p>
</div>


<p>滑出式设计模式可以让开发者在程序中添加常用的导航功能，而又不会浪费屏幕上宝贵的空间。用户可以在任意时间滑出导航面板，并且还可以看到当前屏幕上显示的内容。</p>

<p>现在，互联网上已经有一些库已经内置滑出式设计模式，比如John-Lluch开发的<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a title="SWRevealViewController" href="https://github.com/John-Lluch/SWRevealViewController" target="_blank"><span style="color: #339966; text-decoration: underline;">SWRevealViewController</span></a></span></span>。如果你在寻找更加快捷和简单的方法，那么使用SWRevealViewController库可能是一个很不错的方法。</p>

<p>不过，如果你是一名DIY类型的程序员(像我)，那么你可能希望自己理解这功能是如何实现的。</p>

<p>在本文中，你会看到该功能的实现并不复杂。通过少即是多的方法，并忽略掉复杂大的且不是必须的代码，就可以轻松的在程序中集成滑出式导航面板技术。</p>

<p>下面，就开始学习如何做滑出式导航面板——附带手势滑出的功能！</p>

<h2><strong><span style="color: #339966;">开始</span></strong></h2>

<p>那么这里创建的滑出式导航面板的功能具体是什么呢？</p>

<p>iOS设计师和开发者Ken Yarmosh的解释比较恰当：“滑出式导航面板拥有一个面板，这个面板从主画面的左边或者右边滑出来，然后在面板中显示一个垂直的、独立的滚动视图（Scroll view），把该视图当作程序的主导航。”</p>

<p><em>注意:</em> Ken在这里的文章中详细的解释了滑出式导航面板的设计模式，并介绍了该模式带来的好处：<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://kenyarmosh.com/ios-pattern-slide-out-navigation/" target="_blank"><span style="color: #339966; text-decoration: underline;">新的iOS设计模式:滑出式导航面板</span></a></span></span>。</p>

<p>首先下载本文的<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://cdn2.raywenderlich.com/downloads/SlideOutNavigationStarter.zip" target="_blank"><span style="color: #339966; text-decoration: underline;">启动工程</span></a></span></span>。这是一个ZIP文件，只需要将其保存到本地，并解压一下就可以得到工程。</p>

<p>接着在Xcode中打开这个工程，并看看工程的组织结构：</p>

<p>工程被分为3个主要的文件夹：</p>

<ul>
<li><strong><span style="color: #339966;"><em>Assets</em></span></strong>: 包含所有的图片文件和其它非代码资源（例如attribution文件）。</li>
<li><strong><span style="color: #339966;"><em>Views</em></span></strong>: 包含本文涉及到的所有xib文件。</li>
<li><strong><span style="color: #339966;"><em>Classes</em></span></strong>: 包含Objective-C代码文件</li>
</ul>


<p><img class="alignnone" alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/projectLayout.png" width="262" height="737" /></p>

<p>不要担心Assets中有许多文件，其实你并不需要修改这些内容，所有需要用到的资源文件都添加进来了。</p>

<p>在Views文件夹中有4个主要的view controller。下面是相关简介：</p>

<ul>
<li><strong><span style="color: #339966;">MainViewController</span></strong>: 这是主要的一个画面！这个文件需要添加到你自己的工程中（需要一些小的改动）。</li>
<li><strong><span style="color: #339966;">CenterViewController</span></strong>: 这是正中间的面板。该view controller可以替换为你自己的view controller（记住按钮的action也实现了）</li>
<li><strong><span style="color: #339966;">LeftPanelViewController</span></strong>: 左边的面板。该view controller可以替换为你自己的view controller。</li>
<li><strong><span style="color: #339966;">RightPanelViewController</span></strong>: 右边的面板。该view controller可以替换为你自己的view controller</li>
</ul>


<p>现在打开<strong><span style="color: #339966;">AppDelegate.m</span></strong>文件。虽然你不需要对这个文件做任何改变，但是你应该知道MainViewContorller是左，中和右view controller的容器。这个controller的初始化在19行代码中：</p>

<pre class="wp-code-highlight prettyprint linenums:1">self.viewController = [[MainViewController alloc] initWithNibName:@"MainViewController" bundle:nil];</pre>


<p>现在，你已经对工程的结构熟悉了， 下面我们就正在的开始啦——从正中间的面板开始。</p>

<h2><span style="color: #339966;"><strong>找到中心</strong></span></h2>

<p>本小节中，我将在MainViewConroller中放置一个CenterViewController，将CenterViewController当做MainViewConroller的子view controller。</p>

<p><span style="color: #999999;"><strong>注意</strong>：本小节会用到iOS 5中的新增的一个概念：View Controller Containment。如果你还不熟悉这个概念，可以看看<a href="http://www.raywenderlich.com/store-beta/ios-5-and-ios-6-by-tutorials-bundle" target="_blank"><span style="text-decoration: underline; color: #999999;"><span style="color: #339966; text-decoration: underline;">iOS 5 by Tutorials</span></span></a>中的第22章“UIViewController Containment”。</span></p>

<p>打开MainViewController.m文件，并将下面的import语句添加到文件的顶部：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import "CenterViewController.h"</pre>


<p>接着，添加一个常量定义：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#define CENTER_TAG 1</pre>


<p>接着在@interface中添加下面这个属性，以方便控制center view。</p>

<pre class="wp-code-highlight prettyprint linenums:1">@property (nonatomic, strong) CenterViewController *centerViewController;</pre>


<p>找到setupView并在里面添加如下代码块：</p>

<pre class="wp-code-highlight prettyprint linenums:1">self.centerViewController = [[CenterViewController alloc] initWithNibName:@"CenterViewController" bundle:nil];
self.centerViewController.view.tag = CENTER_TAG;
self.centerViewController.delegate = self;

[self.view addSubview:self.centerViewController.view];
[self addChildViewController:_centerViewController];

[_centerViewController didMoveToParentViewController:self];</pre>


<p>上面的代码分配了一个新的CenterViewController并将其赋值给centerViewController属性。然后将这个view controller view的tag设置为CENTER_TAG。</p>

<p>接着将delegate设置为MainViewController。也就意味着你需要对MainViewController进行修改，以遵循CenterViewControllerDelegate协议——只需要将文件顶部@interface代码行替换为如下即可：</p>

<pre class="wp-code-highlight prettyprint linenums:1">@interface MainViewController ()</pre>


<p>最后，在setupView方法的代码中，使用addSubview:方法将centerViewController的view添加到MainViewController的view中，另外还调用了addChildViewContoller:将_centerViewController添加为MainViewController的子view controller。最后调用了didMoveToParentViewController:方法。</p>

<p>现在就编译并运行程序的话，可以看到类似如下的画面：</p>

<p><a href="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/simMainScreen-333x500.png"><img class="alignnone" alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/simMainScreen-333x500.png" width="333" height="500" /></a></p>

<p>在画面顶部的按钮可以让你切换到小猫（kitties）和小狗（puppies）。有什么更好的理由需要在这里创建一个滑出式的导航面板呢？在这里要想看到不同的小动物，那就开始滑动吧。首先从左边开始！</p>

<h2><span style="color: #339966;"><strong> 靠向左边</strong></span></h2>

<p>现在已经添加好了center panel，不过要添加left view controller需要一些不同的操作。</p>

<p>回到<strong><span style="color: #339966;">MainViewController.m</span></strong>文件中，并将下面的import语句添加到文件顶部：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import "LeftPanelViewController.h"</pre>


<p>然后再定义一个常量：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#define LEFT_PANEL_TAG 2</pre>


<p>接着在@interface中添加一些属性，这跟center view类似：</p>

<pre class="wp-code-highlight prettyprint linenums:1">@property (nonatomic, strong) LeftPanelViewController *leftPanelViewController;
@property (nonatomic, assign) BOOL showingLeftPanel;</pre>


<p>现在找到<strong><span style="color: #339966;">getLeftView</span></strong>方法，删除掉已有的代码并添加如下代码：</p>

<pre class="wp-code-highlight prettyprint linenums:1">// init view if it doesn&#039;t already exist
if (_leftPanelViewController == nil)    
{
    // this is where you define the view for the left panel
    self.leftPanelViewController = [[LeftPanelViewController alloc] initWithNibName:@"LeftPanelViewController" bundle:nil];
    self.leftPanelViewController.view.tag = LEFT_PANEL_TAG;
    self.leftPanelViewController.delegate = _centerViewController;

    [self.view addSubview:self.leftPanelViewController.view];

    [self addChildViewController:_leftPanelViewController];
    [_leftPanelViewController didMoveToParentViewController:self];

    _leftPanelViewController.view.frame = CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height);
}

self.showingLeftPanel = YES;

// set up view shadows
[self showCenterViewWithShadow:YES withOffset:-2];

UIView *view = self.leftPanelViewController.view;
return view;</pre>


<p>上面的代码首先检查一下看看leftPanelViewController属性是否为nil，如果是nil的话，就分配并初始化一个LeftPanelViewController给leftPanelViewController属性。</p>

<p>接着是赋值一个tag和delegate——用于图片的选择，以及将新创建的view添加到main view中。</p>

<p>然后将showingLeftPanel属性设置为YES，并添加了一些视觉上的处理，在下一节中将介绍相关内容。</p>

<p>最后将view返回给调用者。为什么要这样操作——在后面小节中你将看到为什么。</p>

<p><a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/03/showmenow.png"><img class="alignnone" alt="" src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/03/showmenow-480x177.png" width="480" height="177" /></a></p>

<p>&nbsp;</p>

<p>下面，我们来处理一下阴影。</p>

<h2><strong><span style="color: #339966;">不要忘记阴影效果</span></strong></h2>

<p>在上面刚刚添加的代码中，你已经看到调用了showCenterViewWithShow:withOffset:方法。该方法使用QuartzCore框架创建并添加一个阴影效果。</p>

<p>为了访问该框架的提供的许多精彩功能，将下面的import语句添加到<strong><span style="color: #339966;">MainViewController.m</span></strong>文件顶部：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import &lt;QuartzCore/QuartzCore.h&gt;</pre>


<p>同样，在文件顶部定义一个常量，代表圆角。这样，如果你想要修改圆角的话，只需要在一个地方修改即可。</p>

<pre class="wp-code-highlight prettyprint linenums:1">#define CORNER_RADIUS 4</pre>


<p>现在找到<strong><span style="color: #339966;">showCenterViewWithShadow:withOffset: </span></strong>方法，并将下面的代码块添加进去:</p>

<pre class="wp-code-highlight prettyprint linenums:1">if (value)
{        
    [_centerViewController.view.layer setCornerRadius:CORNER_RADIUS];
    [_centerViewController.view.layer setShadowColor:[UIColor blackColor].CGColor];
    [_centerViewController.view.layer setShadowOpacity:0.8];
    [_centerViewController.view.layer setShadowOffset:CGSizeMake(offset, offset)];

}
else
{
    [_centerViewController.view.layer setCornerRadius:0.0f];
    [_centerViewController.view.layer setShadowOffset:CGSizeMake(offset, offset)];
}</pre>


<p>上面的代码中，如果传递过进来的value是非零，就会给center view设置一个圆角和一个阴影。否则就将圆角设置为非圆形。</p>

<p>如果现在运行程序的话，还看不到效果，因为上面的代码还没有用到。</p>

<p><a href="http://cdn1.raywenderlich.com/wp-content/uploads/2013/03/Morewaiting-480x177.png"><img class="alignnone" alt="" src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/03/Morewaiting-480x177.png" width="480" height="177" /></a></p>

<p>&nbsp;</p>

<h2><strong><span style="color: #339966;">现在回到左边</span></strong></h2>

<p>现在已经获得了滑动导航面板所需的一些材料了，接着继续完成left view controller。一旦完成之后，右边如何移动你也会清楚了。</p>

<p>本文中，为了将注意力几种在重要的地方，我已经把IB文件中涉及到的IBAction和IBOutlet连接好了。不过，为了实现你自己的DIY滑出式导航面板，你需要知道这些IB中的按钮是如何配置的。</p>

<p>看看下面这个张关于截图<strong><span style="color: #339966;">CenterViewController.xib</span></strong>文件的截图，注意其中的连接：</p>

<p><img class="alignnone" alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/02/xcodeLeftButtonSetup-sm.png" width="700" height="626" /></p>

<p>如上图中的kitties按钮，已经连接到一个名为leftButton的IBOutlet上了，并且这个按钮的Touch Up Inside事件连接到了一个名为btnMovePanelRight:的IBAction上。这个按钮控制着center panel的滑动，以显示出左边的panel。</p>

<p>btnMovePanelRight:现在还是空的，下面我们就来看看如何实现：</p>

<p>打开<strong><span style="color: #339966;">CenterViewController.m</span></strong>文件，并将下面的代码块添加到<strong><span style="color: #339966;">btnMovePanelRight:</span></strong>方法中：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIButton *button = sender;
switch (button.tag) {
    case 0: {
        [_delegate movePanelToOriginalPosition];
        break;
    }

    case 1: {
        [_delegate movePanelRight];
        break;
    }

    default:
        break;
}</pre>


<p>上面的代码使用了一个switch语句，通过判断leftButton的tag属性来确定center panel是需要移动到右边，还是需要将其移动到原来的正中间位置。这里的leftButton是通过sender参数传递过来的。button的tag设置为0表示center panel已经移动到右边了，如果设置为1的话，表示center panel已经在原来的正中间位置。</p>

<p>如果你看一下CenterViewController.xib文件，会看到我已经将leftButton的tag默认值设置为1。</p>

<p>看到上面的代码中调用了delegate方法吗？如果你还记得的话，之前在配置CenterViewController示例时，已经将它的delegate设置为MainViewController。因此这里的调用就涉及到了MainViewController中的相关方法。</p>

<p>在实现这些delegate方法之前，首先看看<strong><span style="color: #339966;">CenterViewController.h</span></strong>文件中协议CenterViewControllerDelegate的定义：</p>

<p>如下图所示，协议中定义了两个optional协议方法，以及一个required协议方法，分别是：movePanelLeft, movePanelRight 和 movePanelToOriginalPosition。</p>

<p><a href="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/xcodeCenterViewControllerHeader.png"><img class="alignnone" alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/xcodeCenterViewControllerHeader.png" width="700" height="625" /></a></p>

<p>因为CenterViewController的delegate是MainViewController，所以我们在MainViewController中添加这些delegate方法。</p>

<p>打开<strong><span style="color: #339966;">MainViewController.m</span></strong>文件，并添加如下两个常量定义：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#define SLIDE_TIMING .25
#define PANEL_WIDTH 60</pre>


<p>接着找到<strong><span style="color: #339966;">movePanelRight</span></strong>方法，并将如下代码块添加到里面：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIView *childView = [self getLeftView];
[self.view sendSubviewToBack:childView];

[UIView animateWithDuration:SLIDE_TIMING delay:0 options:UIViewAnimationOptionBeginFromCurrentState
                animations:^{
                    _centerViewController.view.frame = CGRectMake(self.view.frame.size.width - PANEL_WIDTH, 0, self.view.frame.size.width, self.view.frame.size.height);
                }
                completion:^(BOOL finished) {
                    if (finished) {

                        _centerViewController.leftButton.tag = 0;
                    }
                }];</pre>


<p><strong>注意</strong>：这个方法是由CenterViewController中的btnMovePanelRight:调用的。更多如何实现delegate相关的信息，请参考：<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://developer.apple.com/library/ios/#documentation/General/Conceptual/DevPedia-CocoaCore/Delegation.html" target="_blank"><span style="color: #339966; text-decoration: underline;">苹果开发者文档</span></a></span></span>。</p>

<p>上面的代码就是奇迹发生的地方！:]</p>

<p>首先调用getLeftView方法，该方法返回一个view，然后将view推到背后，接着是进入动画处理过程：使用一个animateWithDuration:animations:completion: 块。在动画中使用到的SLIDE_TIMING和PANEL_WIDTH值可以随意调整。其中SLIDE_TIMING是控制动画的速度，而PANEL_WIDTH是控制动画过后，center view留在屏幕中的宽度。</p>

<p>另外，记住海的把leftButton的tag属性设置为0。如果你还记得的话，这个tag属性用来跟踪记录center view的当前位置。</p>

<p>现在编译并运行一下程序，看看效果如何。</p>

<p>当程序启动后，点击kitties按钮，center panel应该会滑动到右边，并显示出left panel。此时，屏幕上显示的效果如下图所示：</p>

<p><a href="http://cdn3.raywenderlich.com/wp-content/uploads/2013/02/simLeftReveal-333x500.png"><img class="alignnone" alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/02/simLeftReveal-333x500.png" width="333" height="500" /></a></p>

<p>注意观察center view左边缘的圆角和阴影——这两个效果是执行showCenterViewWithShadow:withOffset:（之前添加的方法）方法得到的结果。</p>

<p>再点击一下kitties按钮——什么事情都没有发生。这是因为还没有实现movePanelToOriginalPosition方法。</p>

<p>回到<span style="color: #339966;"><strong>MainViewController.m</strong></span>文件，并将下面的代码块添加到<span style="color: #339966;"><strong>movePanelToOriginalPosition</strong></span>方法中：</p>

<pre class="wp-code-highlight prettyprint linenums:1">[UIView animateWithDuration:SLIDE_TIMING delay:0 options:UIViewAnimationOptionBeginFromCurrentState
                animations:^{
                    _centerViewController.view.frame = CGRectMake(0, 0, self.view.frame.size.width, self.view.frame.size.height);
                }
                completion:^(BOOL finished) {
                    if (finished) {

                        [self resetMainView];
                    }
                }];</pre>


<p>同样，在上面的代码中使用了一个animateWithDuration:animations:completion: 块来处理动画。不过这次是将center view的位置以动画的方式设置为最初的位置。</p>

<p>当动画完成的时候，调用了resetMainView方法。目前该方法还没有具体的实现。在该方法中需要重置一下view，下面我们来实现一下吧！</p>

<p>找到<strong><span style="color: #339966;">resetMainView</span></strong>方法，并将下面的代码添加到方法中：</p>

<pre class="wp-code-highlight prettyprint linenums:1">// remove left view and reset variables, if needed
if (_leftPanelViewController != nil)
{
    [self.leftPanelViewController.view removeFromSuperview];
    self.leftPanelViewController = nil;

    _centerViewController.leftButton.tag = 1;
    self.showingLeftPanel = NO;
}

// remove view shadows
[self showCenterViewWithShadow:NO withOffset:0];</pre>


<p>上的代码将left panel从view中移除，并将kitties按钮重置为1（表示center view目前是在最初的位置），另外还移除了center view的圆角和阴影效果。</p>

<p>编译并运行程序，当点击kitties按钮后，再次点击kitties按钮，center view会回到最初的位置，如下图所示：</p>

<p><a href="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/simLeftSlideBack-333x500.png"><img class="alignnone" alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/simLeftSlideBack-333x500.png" width="333" height="500" /></a></p>

<p>&nbsp;</p>

<p>下面，在右边添加相关的功能——小狗！——请阅读<span style="text-decoration: underline;"><a href="http://beyondvincent.com/2013/04/17/ios%E4%B8%AD%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%BB%91%E5%87%BA%E5%BC%8F%E5%AF%BC%E8%88%AA%E9%9D%A2%E6%9D%BF2/" target="_blank"><strong><span style="color: #339966; text-decoration: underline;">如何创建一个滑出式导航面板(2)</span></strong></a></span></p>

<h2><span style="font-size: 13px;"> </span></h2>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-11T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 11<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ios/'>iOS</a>, <a class='category' href='/blog/categories/ioskai-fa-ji-lu/'>iOS开发记录</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/11/7/" itemprop="url">Xcode 4.6.1遇到链接错误‘ File Is Universal (2 Slices) but Does Not Contain a(n) Armv7s Slice’</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>今天在新系统OS X10.8.3安装了最新版本的Xcode(Version 4.6.1 (4H512))，尝试把之前的iOS项目运行到iPad 2 上面，Xcode在编译的时候遇到了如下问题：</p>

<p><span style="color: #999999;"><em>(null): File is universal (2 slices) but does not contain a(n) armv7s slice: /Users/beyondvincent/Desktop/IOS/iPhone/iPhone/YYJK/libCorePlot-CocoaTouch.a for architecture armv7s</em></span></p>

<p><span style="color: #800080;"><em>Linker command failed with exit code 1(use -v to see invocation)</em></span></p>

<p>如下图所示：</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-1.png"><img class="alignnone size-medium wp-image-219" alt="QQ20130408-1" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-1-300x25.png" width="300" height="25" /></a></p>

<p>&nbsp;</p>

<p>这是什么原因引起的呢？</p>

<p>实际上是因为Xcode4.6.1增加了对armv7s架构的支持，此时如果工程中使用到的库没有编译为armv7s，而工程又是设置了支持armv7s，那么就会得到上面的错误。在我编译的工程中，我使用Core Plot库就是没有编译为armv7s，所以引起了上面的错误。</p>

<p>修改这个问题有两种方法</p>

<ol>
<li><span style="line-height: 13px;">把Core Plot库编译为armv7s架构即可。</span></li>
<li>把valid architectures设置项中的armv7s移除即可。如下步骤：</li>
</ol>


<p>在工程导航面板中选中工程</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-3.png"><img class="alignnone size-full wp-image-220" alt="QQ20130408-3" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-3.png" width="261" height="40" /></a></p>

<p>在target列表中，选中对于的target</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-4.png"><img class="alignnone size-full wp-image-221" alt="QQ20130408-4" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-4.png" width="111" height="48" /></a></p>

<p>&nbsp;</p>

<p>选中build settings选项</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-5.png"><img class="alignnone size-full wp-image-222" alt="QQ20130408-5" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-5.png" width="297" height="64" /></a></p>

<p>&nbsp;</p>

<p>找到Valid Architectures设置，现在显示的是<strong>armv7 armv7s</strong></p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-6.png"><img class="alignnone size-medium wp-image-223" alt="QQ20130408-6" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-6-300x39.png" width="300" height="39" /></a></p>

<p>&nbsp;</p>

<p>在armv7 armv7s上双击，选中armv7s，选择－按钮</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-7.png"><img class="alignnone size-medium wp-image-224" alt="QQ20130408-7" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-7-300x157.png" width="300" height="157" /></a></p>

<p>&nbsp;</p>

<p>现在valid architectures设置项看起来如下所示：</p>

<p><a href="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-8.png"><img class="alignnone size-medium wp-image-225" alt="QQ20130408-8" src="http://beyondvincent.com/wp-content/uploads/2013/04/QQ20130408-8-300x46.png" width="300" height="46" /></a></p>

<p>&nbsp;</p>

<p>再次编译并运行程序，可以看到iPad 2上已经能够运行了。:]</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-11T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 11<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/raywenderlichfan-yi/'>raywenderlich翻译</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/11/6/" itemprop="url">25个增强iOS应用程序性能的提示和技巧 — 高级篇</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<em><em><strong><br/>
本文由破船译自：<a href="http://www.raywenderlich.com/31166/25-ios-app-performance-tips-tricks" target="_blank">raywenderlich</a><br/>
转载请注明出处：<a href="http://www.beyondvincent.com" target="_blank">BeyondVincent的博客</a><br/>
_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong></em></em></p>

<p>在开发iOS应用程序时，让程序具有良好的性能是非常关键的。这也是用户所期望的，如果你的程序运行迟钝或缓慢，会招致用户的差评。</p>

<p>然而由于iOS设备的局限性，有时候要想获得良好的性能，是很困难的。在开发过程中，有许多事项需要记住，并且关于性能影响很容易就忘记。</p>

<p>这就是为什么我要写这篇文章！本文收集了25个关于可以提升程序性能的提示和技巧。</p>

<h2><span style="color: #008000;">目录</span></h2>

<p>我把性能优化技巧分为3个不同的等级：<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=180"><span style="color: #339966; text-decoration: underline;">初级</span></a></span></span>、<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=258"><span style="color: #339966; text-decoration: underline;">中级</span></a></span></span>和高级：</p>

<p><span style="color: #008000;"><strong> </strong></span></p>

<p><span style="color: #008000;"><strong>高级</strong></span><br/>
当且仅当下面这些技巧能够解决问题的时候，才使用它们：</p>

<ol start="22">
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#launchtime"><span style="color: #008000; text-decoration: underline;">加速启动时间</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#autoreleasepool"><span style="color: #008000; text-decoration: underline;">使用Autorelease Pool</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#cacheimages"><span style="color: #008000; text-decoration: underline;">缓存图片 — 或者不缓存</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#avoidformatters"><span style="color: #008000; text-decoration: underline;">尽量避免Date格式化</span></a></span>
  </li>
</ol>


<h2></h2>

<h2><span style="color: #339966;">高级性能提升</span></h2>

<p>寻找一些高明的方法，让自己变为一个全代码忍者？下面这些高级的性能优化技巧可以在适当的时候让程序尽可能的高效运行！</p>

<p><em id="__mceDel"> <a name="launchtime"></a><br /> <span style="color: #008000;">22) 加速启动时间</span></em></p>

<p>能快速的启动程序非常重要，特别是在用户第一次启动程序时。第一映像对程序来说非常重要！</p>

<p>让程序尽量快速启动的方法就是尽量以异步方式执行任务，例如网络请求，数据访问或解析。</p>

<p>另外，避免使用臃肿的XIBs，因为XIB的加载是在主线程中进行的。但是记住storyboard没有这样的问题——所以如果可以的话就使用storyboard吧！</p>

<p><em><span style="color: #999999;"><strong><span style="color: #ff0000;">注意</span></strong>：在利用Xcode进行调试时，watchdog不会运行，所在设备中测试程序启动性能时，不要将设备连接到Xcode。</span></em></p>

<p><em id="__mceDel"> <a name="autoreleasepool"></a><br /> <span style="color: #008000;">23) 使用Autorelease Pool</span></em></p>

<p>NSAutoreleasePool负责释放一个代码块中的自动释放对象。一般都是由UIKit来创建的。不过有些情况下需要手动创建NSAutoreleasePool。</p>

<p>例如，如果在代码中创建了大量的临时对象，你将注意到内存使用量在增加，直到这些对象被释放。问题是只有当UIKit耗尽了 autorelease pool，这些对象才会被释放，也就是说当不再需要这些对象之后，这些对象还在内存中占据着资源。</p>

<p>不过这个问题完全可以避免：在@autoreleasepool代码块中创建临时对象，如下代码：</p>

<pre class="wp-code-highlight prettyprint linenums:1">NSArray *urls = &lt;# An array of file URLs #&gt;;
for (NSURL *url in urls) {
    @autoreleasepool {
        NSError *error;
        NSString *fileContents = [NSString stringWithContentsOfURL:url
                                         encoding:NSUTF8StringEncoding error:&amp;error];
        /* Process the string, creating and autoreleasing more objects. */
    }
}</pre>


<p>当每次迭代完之后，都会释放所有的autorelease对象。</p>

<p>关于NSAutoreleasePool的更多内容可以阅读苹果的<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://developer.apple.com/library/ios/#documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html" target="_blank"><span style="color: #339966; text-decoration: underline;">官方文档</span></a></span></span>。</p>

<p><em id="__mceDel"><br /> <a name="cacheimages"></a><br /> <span style="color: #008000;">24) 缓存图片 — 或者不缓存</span></em></p>

<p>iOS中从程序bundle中加载UIImage一般有两种方法。第一种比较常见：<strong><span style="color: #339966;">imageNamed</span></strong>。第二种方法很少使用：<strong><span style="color: #339966;"><em>imageWithContentsOfFile</em></span></strong></p>

<p>为什么有两种方法完成同样的事情呢？</p>

<p><strong><span style="color: #339966;">imageNamed</span></strong>的优点在于可以缓存已经加载的图片。<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://developer.apple.com/library/ios/#documentation/uikit/reference/UIImage_Class/Reference/Reference.html" target="_blank"><span style="color: #339966; text-decoration: underline;">苹果的文档</span></a></span></span>中有如下说法：</p>

<p><em><span style="color: #999999;">This method looks in the system caches for an image object with the specified name and returns that object if it exists. If a matching image object is not already in the cache, this method loads the image data from the specified file, caches it, and then returns the resulting object.</span></em></p>

<p><em><span style="color: #999999;"> 这种方法会在系统缓存中根据指定的名字寻找图片，如果找到了就返回。如果没有在缓存中找到图片，该方法会从指定的文件中加载图片数据，并将其缓存起来，然后再把结果返回。</span></em></p>

<p>而<strong><span style="color: #339966;">imageWithContentsOfFile</span></strong>方法只是简单的加载图片，并不会将图片缓存起来。</p>

<p>这两个方法的使用方法如下：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIImage *img = [UIImage imageNamed:@"myImage"]; // caching
// or
UIImage *img = [UIImage imageWithContentsOfFile:@"myImage"]; // no caching</pre>


<p>那么该如何选择呢？</p>

<p>如果加载一张很大的图片，并且只使用一次，那么就不需要缓存这个图片。这种情况<strong><span style="color: #339966;">imageWithContentsOfFile</span></strong>比较合适——系统不会浪费内存来缓存图片。</p>

<p>然而，如果在程序中经常需要重用的图片，那么最好是选择<strong><span style="color: #339966;">imageNamed</span></strong>方法。这种方法可以节省出每次都从磁盘加载图片的时间。</p>

<p><a name="avoidformatters"></a><br/>
<span style="color: #008000;">25) 尽量避免Date格式化</span></p>

<p>如果有许多日期需要使用NSDateFormatter，那么需要小心对待了。如之前（<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://beyondvincent.com/2013/04/11/25%e4%b8%aa%e5%a2%9e%e5%bc%baios%e5%ba%94%e7%94%a8%e7%a8%8b%e5%ba%8f%e6%80%a7%e8%83%bd%e7%9a%84%e6%8f%90%e7%a4%ba%e5%92%8c%e6%8a%80%e5%b7%a7-%e4%b8%ad%e7%ba%a7%e7%af%87/#reuseobjects" target="_blank"><span style="color: #339966; text-decoration: underline;">重用花销很大的对象</span></a></span></span>）所提到的，无论什么时候，都应该尽量重用NSDateFormatters。</p>

<p>然而，如果你需要更快的速度，那么应该使用C来直接解析日期，而不是NSDateFormatter。Sam Soffes写了一篇文章，其中提供了一些解析ISO-8601格式日期字符的串代码。你只需要简单的调整一下其中的代码就可以满足自己特殊的需求了。</p>

<p>这听起来不错把——不过你相信这还有更好的一个办法吗？</p>

<p>如果你自己能控制处理日期的格式，那么可以选择 <span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://en.wikipedia.org/wiki/Unix_time" target="_blank"><span style="color: #339966; text-decoration: underline;">Unix timestamps</span></a></span></span>。Unix timestamps是一个简单的整数，代表了从新纪元时间（epoch）开始到现在已经过了多少秒，通常这个新纪元参考时间是00:00:00 UTC on 1 January 1970。</p>

<p>你可以很容易的见这个时间戳转换为NSDate，如下所示：</p>

<pre class="wp-code-highlight prettyprint linenums:1">- (NSDate*)dateFromUnixTimestamp:(NSTimeInterval)timestamp {
    return [NSDate dateWithTimeIntervalSince1970:timestamp];
}</pre>


<p>上面这个方法比C函数还要快！</p>

<p>注意：许多网络APIs返回的时间戳都是毫秒，因此需要注意的是在将这个时间戳传递给dateFromUnixTimestamp之前需要除以1000。</p>

<p>&nbsp;</p>

<h2><span style="color: #339966;">何去何从？</span></h2>

<p>强烈建议对程序性能优化感兴趣的读者看看下面列出来的WWDC视频。在看视频之前，你需要注册一个Apple ID（只需要注册以此，就可以观看所有<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://developer.apple.com/videos/wwdc/2012/" target="_blank"><span style="color: #339966; text-decoration: underline;">WWDC2012</span></a></span></span>的视频）：</p>

<ul>
<li><h1>406: Adopting Automatic Reference Counting</h1></li>
<li><h1>238: iOS App Performance: Graphics and Animations</h1></li>
<li><h1>242: iOS App Performance: Memory</h1></li>
<li><h1>235: iOS App Performance: Responsiveness</h1></li>
<li><h1>409: Learning Instruments</h1></li>
<li><h1>706: Networking Best Practices</h1></li>
<li><h1>514: OpenGL ES Tools and Techniques</h1></li>
<li><h1>506: Optimizing 2D Graphics and Animation Performance</h1></li>
<li><h1>601: Optimizing Web Content in UIWebViews and Websites on iOS</h1></li>
<li><h1>225: Up and Running: Making a Great Impression with Every Launch</h1></li>
</ul>


<p>下面这些视频来自<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://developer.apple.com/videos/wwdc/2011/" target="_blank"><span style="color: #339966; text-decoration: underline;">WWDC 2011</span></a> </span></span>，也非常有用：</p>

<ul>
<li><h1>308: Blocks and Grand Central Dispatch in Practice</h1></li>
<li><h1>323: Introducing Automatic Reference Counting</h1></li>
<li><h1>312: iOS Performance and Power Optimization with Instruments</h1></li>
<li><h1>105: Polishing Your App: Tips and tricks to improve the responsiveness and performance</h1></li>
<li><h1>121: Understanding UIKit Rendering</h1></li>
</ul>


<p>这里还有<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://developer.apple.com/videos/ios/" target="_blank"><span style="color: #339966; text-decoration: underline;">更多相关视频</span></a></span></span>，大多数来自iOS 5技术讲座：</p>

<ul>
<li>Your iOS App Performance Hitlist</li>
<li>Optimizing App Performance with Instruments</li>
<li>Understanding iOS View Compositing</li>
</ul>


<p>基于 “Your iOS App Performance Hitlist” 视频，Ole Begemann写了<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://oleb.net/blog/2011/11/ios5-tech-talk-michael-jurewitz-on-performance-measurement/" target="_blank"><span style="color: #339966; text-decoration: underline;">一篇文章</span></a>。</span></span></p>

<p>苹果还提供了一篇非常好的文章：<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://developer.apple.com/library/ios/#documentation/iphone/conceptual/iphoneosprogrammingguide/PerformanceTuning/PerformanceTuning.html" target="_blank"><span style="color: #339966; text-decoration: underline;">性能优化</span></a></span></span>。其中提供的技巧和提示对程序性能提升很有帮助。</p>

<p>&nbsp;</p>

<p><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=180" target="_blank"><span style="color: #339966; text-decoration: underline;">25个增强iOS应用程序性能的提示和技巧 — 初级篇</span></a></span></span><br/>
<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=258" target="_blank"><span style="color: #339966; text-decoration: underline;">25个增强iOS应用程序性能的提示和技巧 — 中级篇</span></a></span></span><a href="http://beyondvincent.com/?p=263" target="_blank"><br /> </a></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-11T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 11<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/raywenderlichfan-yi/'>raywenderlich翻译</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/11/5/" itemprop="url">25个增强iOS应用程序性能的提示和技巧 — 中级篇</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<em><em><strong><br/>
本文由破船译自：<a href="http://www.raywenderlich.com/31166/25-ios-app-performance-tips-tricks" target="_blank">raywenderlich</a><br/>
转载请注明出处：<a href="http://www.beyondvincent.com" target="_blank">BeyondVincent的博客</a><br/>
_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong></em></em></p>

<p>在开发iOS应用程序时，让程序具有良好的性能是非常关键的。这也是用户所期望的，如果你的程序运行迟钝或缓慢，会招致用户的差评。</p>

<p>然而由于iOS设备的局限性，有时候要想获得良好的性能，是很困难的。在开发过程中，有许多事项需要记住，并且关于性能影响很容易就忘记。</p>

<p>这就是为什么我要写这篇文章！本文收集了25个关于可以提升程序性能的提示和技巧。</p>

<h2><span style="color: #008000;">目录</span></h2>

<p>我把性能优化技巧分为3个不同的等级：<span style="text-decoration: underline; color: #339966;"><a href="http://beyondvincent.com/?p=180"><span style="color: #339966; text-decoration: underline;">初级</span></a></span>、中级和<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=263"><span style="color: #339966; text-decoration: underline;">高级</span></a></span></span>：</p>

<p><span style="color: #008000;"><strong>中级</strong></span></p>

<p>在性能优化时，当你碰到一些复杂的问题，应该注意和使用如下技巧：</p>

<ol start="9">
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#lazyviews"><span style="color: #008000; text-decoration: underline;">重用和延迟加载View</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#cache"><span style="color: #008000; text-decoration: underline;">缓存、缓存、缓存</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#drawing"><span style="color: #008000; text-decoration: underline;">考虑绘制</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#memwarnings"><span style="color: #008000; text-decoration: underline;">处理内存警告</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#reuseobjects"><span style="color: #008000; text-decoration: underline;">重用花销很大的对象</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#spritesheets"><span style="color: #008000; text-decoration: underline;">使用Sprite Sheets</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#avoidreprocess"><span style="color: #008000; text-decoration: underline;">避免重新处理数据</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#chooserightformat"><span style="color: #008000; text-decoration: underline;">选择正确的数据格式</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#bgimages"><span style="color: #008000; text-decoration: underline;">设置适当的背景图片</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><span style="text-decoration: underline;"><a href="#reduceweb"><span style="color: #008000; text-decoration: underline;">降低Web内容的影响</span></a></span></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#shadowpath"><span style="color: #008000; text-decoration: underline;">设置阴影路径</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#tableviews"><span style="color: #008000; text-decoration: underline;">优化TableView</span></a></span>
  </li>
  <li>
    <span style="text-decoration: underline; color: #008000;"><a href="#datastorage"><span style="color: #008000; text-decoration: underline;">选择正确的数据存储方式</span></a></span>
  </li>
</ol>


<p>&nbsp;</p>

<h2><span style="color: #339966;">中级性能提升</span></h2>

<p>现在，在进行代码优化时，你已经能够完成一些初级性能优化了。但是下面还有另外一些优化方案，虽然可能不太明显（取决于程序的架构和相关代码），但是，如果能够正确的利用好这些方案，那么它们对性能的优化将非常明显！</p>

<p><a name="lazyviews"></a><br/>
<span style="color: #008000;">9) 重用和延迟加载View</span></p>

<p>程序界面中包含更多的view，意味着界面在显示的时候，需要进行更多的绘制任务；也就意味着需要消耗更多的CPU和内存资源。特别是在一个UIScrollView里面加入了许多view。</p>

<p>这种情况的管理技巧可以参考UITableView和UICollectionView的行为：不要一次性创建所有的subview，而是在需要的时候在创建view，并且当view使用完毕时候将它们添加到重用队列中。</p>

<p>这样就可以仅在UIScrollView滚动的时候才配置view，以此可以避免分配创建view的带来的成本——这可能是非常耗资源的。</p>

<p>现在有这样的一个问题：在程序中需要显示的view在什么时机创建（比如说，当用户点击某个按钮，需要显示某个view）。这里有两种可选方法：</p>

<ol>
<li>在屏幕第一次加载以及隐藏的时候，创建view；然后在需要的时候，再把view显示出来。</li>
<li>直到需要显示view的时候，才创建并显示view。</li>
</ol>


<p>每种方法都有各自的优点和确定。</p>

<p>使用第一种方法，需要消耗更多的内容，因为创建出来的view一直占据着内存，直到view被release掉。不过，使用这种方法，当用户点击按钮时，程序会很快的显示出view，因为只需要修改一下view的可见性即可。</p>

<p>而使用第二种方法则产生相反的效果；当需要的时候猜创建view，这会消耗更少的内存；不过，当用户点击按钮的时候，不会立即显示出view。</p>

<p><a name="cache"></a><br/>
<span style="color: #008000;">10) 缓存、缓存、缓存</span></p>

<p>在开发程序时，一个重要的规则就是“缓存重要的内容”——这些内容一般不会改变，并且访问的频率比较高。</p>

<p>可以缓存写什么内容呢？比如远程服务器的响应内容，图片，甚至是计算结果，比如UITableView的行高。</p>

<p>NSURLConnection根据HTTP头的处理过程，已经把一些资源缓存到磁盘和内存中了。你甚至可以手动创建一个NSURLRequest ，让其只加载缓存的值。</p>

<p>下面的代码片段一般用在为图片创建一个NSURLRequest：</p>

<pre class="wp-code-highlight prettyprint linenums:1">+ (NSMutableURLRequest *)imageRequestWithURL:(NSURL *)url {
    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];

    request.cachePolicy = NSURLRequestReturnCacheDataElseLoad; // this will make sure the request always returns the cached image
    request.HTTPShouldHandleCookies = NO;
    request.HTTPShouldUsePipelining = YES;
    [request addValue:@"image/*" forHTTPHeaderField:@"Accept"];

    return request;
}</pre>


<p>注意：你可以使用NSURLConnection抓取一个URL请求，但是同样可以使用AFNetworking来抓取，这种方法不用修改所有网络相关的代码——这是一个技巧！:]</p>

<p>如果你要直到更多关于HTTP 缓存, NSURLCache, NSURLConnection 以及相关的内容, 那么看一下NSHipster中的<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://nshipster.com/nsurlcache/" target="_blank"><span style="color: #339966; text-decoration: underline;">the NSURLCache entry</span></a></span></span>。</p>

<p>如果你需要缓存的内容没涉及到HTTP请求，那么使用NSCache。</p>

<p>NSCache的外观和行为与NSDictionary类似, 但是，当系统需要回收内存时，NSCache会自动的里面存储的内容。Mattt Thompson 在NSHipster上写了<span style="color: #339966;"><a href="http://nshipster.com/nscache/"><span style="color: #339966;">一篇关于NSCache非常不错的文章</span></a></span>。</p>

<p>如果还想知道关于HTTP缓存更多的内容，那么建议阅读一下Google的这篇文章：<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://developers.google.com/speed/docs/best-practices/caching" target="_blank"><span style="color: #339966; text-decoration: underline;">best-practices document on HTTP caching</span></a></span></span>。</p>

<ul>
<li><a name="drawing"></a><br/>
<span style="color: #008000;">11) 考虑绘制</span>*</li>
</ul>


<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn3.raywenderlich.com/wp-content/uploads/2010/09/CoreGraphics101.jpg"><img alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2010/09/CoreGraphics101.jpg" width="250" height="195" /></a><p class="wp-caption-text">
    考虑绘制
  </p>
</div>


<p>&nbsp;</p>

<p>在iOS中制作漂亮的按钮有多种方法。可以使用全尺寸图片，可缩放图片，或者使用CALayer, CoreGraphics， 甚至是OpenGL来手动测量和绘制按钮。</p>

<p>当然，这些方法的复杂程度也不同，并且性能也有所区别。这里有一篇相关文章值得阅读一下：<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://robots.thoughtbot.com/post/36591648724/designing-for-ios-graphics-performance" target="_blank"><span style="color: #339966; text-decoration: underline;">关于iOS中图形的性能</span></a></span></span>。其中Andy Matuschak（曾经是苹果的UIKit小组的组员）对这篇文章的评论中，对于不同的方法及其性能权衡有非常好的一个见解。</p>

<p>简单来说，使用预渲染图片技术是最快的，因为iOS中不用等到在屏幕上显示的时候才创建图形和对形状进行绘制（图片已经创建好了!）。这样带来的问题是需要把所有的图片都放到程序bundle中，从而增加了程序的大小。因此使用可伸缩图片在这里将排上用场了：可以移除“浪费”空间的图片——iOS可以重复利用。并且针对不同的元素（例如按钮）不需要创建不同的图片。</p>

<p>不过，使用图片的话会失去代码对图片的控制能力，进而针对不同的程序，就需要重复的生成每一个需要的图片，并反复的放到每个程序中。这个处理过程一般会比较慢。另外一点就是如果你需要一个动画，或者许多图片都要进行轻微的调整（比如多个颜色的覆盖），那么需要在程序中加入许多图片，进而增加了程序bundle的大小。</p>

<p>总的来说，你需要考虑一下什么才是最重要的：绘制性能还是程序大小。一般来说都重要，所以在同一个工程中，应该两种都应考虑。</p>

<p><em id="__mceDel"> <a name="memwarnings"></a><br /> <span style="color: #008000;">12) 处理内存警告</span></em></p>

<p>当系统内存偏低时，iOS会通知所有在运行的程序。<a href="http://developer.apple.com/library/ios/#documentation/iphone/conceptual/iphoneosprogrammingguide/PerformanceTuning/PerformanceTuning.html" target="_blank"><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;">苹果的官方文档</span></span></a>中介绍了如何处理低内存警告：</p>

<p><em><span style="color: #999999;">If your app receives this warning, it must free up as much memory as possible. The best way to do this is to remove strong references to caches, image objects, and other data objects that can be recreated later.</span></em></p>

<p><em><span style="color: #999999;">如果程序收到了低内存警告，在程序中必须尽量释放内存。最佳方法就是移除强引用的涉及到的缓存，图片对象，以及其它可以在之后使用时还可以重新创建的数据对象。</span></em></p>

<p>UIKit中提供了如下几种方法来接收低内存（low-memory）警告：</p>

<ul>
<li>实现app delegate中的applicationDidReceiveMemoryWarning: 方法。</li>
<li>在UIViewController子类中重写(Override)didReceiveMemoryWarning方法。</li>
<li>在通知中心里面注册UIApplicationDidReceiveMemoryWarningNotificatio通知。</li>
</ul>


<p>在收到以上任意的警告时，需要立即释放任何不需要的内存。</p>

<p>例如，UIViewController的默认情况是清除掉当前不可见的view；在UIViewController的子类中，可以清除一些额外的数据。程序中不没有显示在当前屏幕中的图片也可以release掉。</p>

<p>当收到低内存警告时，尽量释放内存是非常重要的。否则，运行中的程序有可能会被系统杀掉。</p>

<p>不过，在清除内存时要注意一下：确保被清除的对象之后还可以被创建出来。另外，在开发程序的时候，请使用iOS模拟器中的模拟内存警告功能对程序进行测试！</p>

<p><em id="__mceDel"> <a name="reuseobjects"></a><br /> <span style="color: #008000;">13) 重用花销很大的对象<a href="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/34659787-250x250.jpg"><img class="alignright" alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/02/34659787-250x250.jpg" width="250" height="250" /></a></span></em></p>

<p>有些对象的初始化非常慢——比如NSDateFormatter和NSCalendar。不过有时候可以避免使用这些对象，例如在解析JSON/XML中的日期时。</p>

<p>当使用这些对象时，为了避免性能上的瓶颈，可以尝试尽量重用这些对象——在类中添加一个属性或者创建一个静态变量。</p>

<p>注意，如果使用静态变量的话，对象会在程序运行的时候一直存在，就像单例一样。</p>

<p>下面的代码演示创建一个延迟加载的日期格式属性。第一次调用属性的时候，会创建一个新的日期格式。之后再调用的话，会返回已经创建好的实例对象：</p>

<pre class="wp-code-highlight prettyprint linenums:1">// in your .h or inside a class extension
@property (nonatomic, strong) NSDateFormatter *formatter;

// inside the implementation (.m)
// When you need, just use self.formatter
- (NSDateFormatter *)formatter {
    if (! _formatter) {
        _formatter = [[NSDateFormatter alloc] init];
        _formatter.dateFormat = @"EEE MMM dd HH:mm:ss Z yyyy"; // twitter date format
    }
    return _formatter;
}</pre>


<p>另外，还需要记住的是在设置NSDateFormatter的日期格式时，同样跟创建新的一个NSDateFormatter实例对象时一样慢！因此，在程序中如果需要频繁的处理日期格式，那么对NSDateFormatter进行重用是非常好的。</p>

<ul>
<li><a name="spritesheets"></a><br/>
<span style="color: #008000;">14) 使用Sprite Sheets</span>*</li>
</ul>


<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn2.raywenderlich.com/wp-content/uploads/2010/11/TexturePackerSmall.jpg"><img alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2010/11/TexturePackerSmall.jpg" width="250" height="264" /></a><p class="wp-caption-text">
    使用sprite sheets
  </p>
</div>


<p>你是一个游戏开发者吗？是的话那么sprite sheets是最佳选择之一。使用Sprite sheets跟常用的绘制方法比起来，绘制更快，并且消耗更少的内存。</p>

<p>下面是两个非常不错的sprite sheets教程：</p>

<ol>
<li><span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://www.raywenderlich.com/32045/how-to-use-animations-and-sprite-sheets-in-cocos2d-2-x" target="_blank"><span style="color: #339966; text-decoration: underline;">如何在Cocos2D中使用动画和Sprite Sheets</span></a></span></span><a href="http://www.raywenderlich.com/32045/how-to-use-animations-and-sprite-sheets-in-cocos2d-2-x" target="_blank"><br /> </a></li>
<li><a href="http://www.raywenderlich.com/2361/how-to-create-and-optimize-sprite-sheets-in-cocos2d-with-texture-packer-and-pixel-formats" target="_blank"><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;">如何在Cocos2D中使用纹理包（Texture Packer）和像素格式来创建并优化Sprite Sheets</span></span></a><a href="http://www.raywenderlich.com/2361/how-to-create-and-optimize-sprite-sheets-in-cocos2d-with-texture-packer-and-pixel-formats" target="_blank"><br /> </a></li>
</ol>


<p>第二个教程详细的介绍了像素格式——在游戏中可以衡量性能的影响。</p>

<p>如果你还不熟悉sprite sheets，那么可以看看这里的介绍：<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://www.youtube.com/watch?v=crrFUYabm6E" target="_blank"><span style="color: #339966; text-decoration: underline;">SpriteSheets – 视频, Part 1</span></a></span></span>and <span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="https://www.youtube.com/watch?v=_KyUqyS5MLA" target="_blank"><span style="color: #339966; text-decoration: underline;">Part 2</span></a>.</span></span> 这两个视频的作者是Andreas Löw, 他是纹理包(Texture Packer)的创建者, 纹理包是创建sprite sheets的重要工具。</p>

<p>除了使用sprite sheets外，这里还介绍了一些用于游戏开发中的技巧，例如，如果你有很多sprite（比如射击类游戏中），那么可以重用sprite，而不用每次都创建sprite。</p>

<p><em id="__mceDel"> <a name="avoidreprocess"></a><br /> <span style="color: #008000;">15) 避免重新处理数据</span></em></p>

<p>许多程序都需要从远程服务器中获取数据，以满足程序的需求。这些数据一般是JSON或XML格式。在请求和接收数据时，使用相同的数据结构非常重要。</p>

<p>为什么呢？在内存中把数据转换为适合程序的数据格式是需要付出额外代价的。</p>

<p>例如，如果你需要在table view中显示一些数据，那么请求和接收的数据格式最好是数组格式的，这样可以避免一些中间操作——将数据转换为适合程序使用的数据结构。</p>

<p>类似的，如果程序是根据键来访问具体的值，那么最好请求和接收一个键/值对字典。</p>

<p>在第一时间获得的数据就是所需要格式的，可以避免将数据转换为适合程序的数据格式带来的额外代价。</p>

<ul>
<li><a name="chooserightformat"></a><br/>
<span style="color: #008000;">16) 选择正确的数据格式</span>*</li>
</ul>


<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn3.raywenderlich.com/wp-content/uploads/2011/10/iOS_feast_JSON.jpg"><img alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2011/10/iOS_feast_JSON.jpg" width="250" height="250" /></a><p class="wp-caption-text">
    选择正确的数据格式
  </p>
</div>


<p>&nbsp;</p>

<p>将数据从程序传到网络服务器中有多种方法，其中使用的数据格式基本都是JSON和XML。你需要做的就是在程序中选择正确的数据格式。</p>

<p>JSON的解析速度非常快，并且要比XML小得多，也就意味着只需要传输更少数据。并且在iOS5之后，已经有<span style="text-decoration: underline; color: #339966;"><span style="text-decoration: underline;"><a href="http://www.raywenderlich.com/5492/working-with-json-in-ios-5" target="_blank"><span style="text-decoration: underline; color: #339966;">内置的JSON反序列化</span></a>API</span></span>了，所以使用JSON是很容易的。</p>

<p>不过XML也有它自己的优势：如果使用SAX方法来解析XML，那么可以边读XML边解析，并不用等到全部的XML获取到了才开始解析，这与JSON是不同的。当处理大量数据时，这种方法可以提升性能并减少内存的消耗。</p>

<p><em id="__mceDel"> <a name="bgimages"></a><br /> <span style="color: #008000;">17) 设置适当的背景图片</span></em></p>

<p>在iOS编码中，跟别的许多东西类似，这里也有两种方法来给view设置一个背景图片：</p>

<ol>
<li>可以使用UIColor的colorWithPatternImge方法来创建一个颜色，并将这个颜色设置为view的背景颜色。</li>
<li>可以给view添加一个UIImageView子视图。</li>
</ol>


<p>如果你有一个全尺寸的背景图片，那么应该使用UIImageView，因为UIColor的colorWithPatternImge方法是用来创建小图片的——该图片会被重复使用。此时使用UIImageView会节省很多内存。</p>

<pre class="wp-code-highlight prettyprint linenums:1">// You could also achieve the same result in Interface Builder
UIImageView *backgroundView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"background"]];
[self.view addSubview:backgroundView];</pre>


<p>不过，如果你计划用小图片当做背景，那么应该使用UIColor的colorWithPatternImge方法。这种情况下绘制速度会很快，并且不会消耗大量的内存。</p>

<pre class="wp-code-highlight prettyprint linenums:1">self.view.backgroundColor = [UIColor colorWithPatternImage:[UIImage imageNamed:@"background"]];</pre>


<p><em id="__mceDel"> <a name="reduceweb"></a><br /> <span style="color: #008000;">18) 降低Web内容的影响</span></em></p>

<p>UIWebView非常有用。用它可以很容易的显示web内容，甚至可以构建UIKit空间难以显示的内容。</p>

<p>不过，你可以能已经注意到程序中使用的UIWebView组建没有苹果的Safari程序快。这是因为<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://en.wikipedia.org/wiki/Just-in-time_compilation" target="_blank"><span style="color: #339966; text-decoration: underline;">JIT编译</span></a></span></span>限制了WebKit的Nitro引擎的使用。</p>

<p>因此为了获得更加的性能，需要调整一下HTML的大小。首先就是尽量的摆脱JavaScript，并避免使用大的矿建，例如jQuery。有时候使用原始的JavaScript要比别的框架快。</p>

<p>另外，尽量的异步加载JavaScript文件——特别是不直接影响到页面行为时，例如分析脚本。</p>

<p>最后——让使用到的图片，跟实际需要的一样大小。如之前提到的，尽量使用sprite sheets，以此节省内存和提升速度。</p>

<p>更多相关信息，可以看一下： <span style="text-decoration: underline; color: #339966;"><span style="text-decoration: underline;"><a href="http://developer.apple.com/videos/wwdc/2012/"><span style="color: #339966; text-decoration: underline;">WWDC 2012 session #601 – 在iOS中优化UIWebView和网站中的Web内容。</span></a></span></span></p>

<p><em id="__mceDel"> <a name="shadowpath"></a><br /> <span style="color: #008000;">19) 设置阴影路径</span></em></p>

<p>如果需要在view活layer中添加一个阴影，该如何处理呢？</p>

<p>大多数开发者首先将QuartzCore框架添加到工程中，然后添加如下代码：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import &lt;QuartzCore/QuartzCore.h&gt;

// Somewhere later ...
UIView *view = [[UIView alloc] init];

// Setup the shadow ...
view.layer.shadowOffset = CGSizeMake(-1.0f, 1.0f);
view.layer.shadowRadius = 5.0f;
view.layer.shadowOpacity = 0.6;</pre>


<p>看起来非常容易，不是吗？</p>

<p>然而不幸的是上面这种方法有一个问题。Core Animation在渲染阴影效果之前，必须通过做一个离屏(offscreen)才能确定view的形状，而这个离屏操作非常耗费资源。</p>

<p>下面有一种方法可以更容易的让系统进行阴影渲染：设置阴影路径！</p>

<pre class="wp-code-highlight prettyprint linenums:1">view.layer.shadowPath = [[UIBezierPath bezierPathWithRect:view.bounds] CGPath];</pre>


<p>通过设置阴影路径，iOS就不用总是再计算该如何绘制阴影了。只需要使用你预先计算好的路径即可。有一点不好的是，根据view的格式，自己可能很难计算出路径。另外一个问题就是当view的frame改变时，必须每次都更新一下阴影路径。</p>

<p>如果你想了解更多相关信息，Mark Pospesel写了一篇很棒的文章：<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://markpospesel.wordpress.com/2012/04/03/on-the-importance-of-setting-shadowpath/" target="_blank"><span style="color: #339966; text-decoration: underline;">shadowPath</span></a></span></span>。</p>

<p><em id="__mceDel"> <a name="tableviews"></a><br /> <span style="color: #008000;">20) 优化TableView</span></em></p>

<p>Table views需要快速的滚动——如果不能的话，用户会感觉到停顿。</p>

<p>为了让table view平滑的滚动，确保遵循了如下建议：</p>

<ul>
<li>设置正确的reuseIdentifer以重用cell。</li>
<li>尽量将view设置为不透明，包括cell本身。</li>
<li>避免渐变，图像缩放以及离屏绘制。</li>
<li>如果row的高度不相同，那么将其缓存下来。</li>
<li>如果cell显示的内容来此网络，那么确保这些内容是通过异步来获取的。</li>
<li>使用shadowPath来设置阴影。</li>
<li>减少subview的数量。</li>
<li>在cellForRowAtIndexPath:中尽量做更少的操作。如果需要做一些处理，那么最好做过一次之后，就将结果缓存起来。</li>
<li>使用适当的数据结构来保存需要的信息。不同的结构会带来不同的操作代价。</li>
<li><p>使用rowHeight, sectionFooterHeight 和 sectionHeaderHeight 来设置一个恒定 高度，而不要从delegate中获取。</p></li>
<li><p><a name="datastorage"></a><br/>
<span style="color: #008000;">21) 选择正确的数据存储方式</span>*</p></li>
</ul>


<div class="wp-caption alignright" style="width: 313px">
  <a href="http://cdn5.raywenderlich.com/wp-content/uploads/2010/04/FailedBanksModel.jpg"><img alt="" src="http://cdn5.raywenderlich.com/wp-content/uploads/2010/04/FailedBanksModel.jpg" width="303" height="136" /></a><p class="wp-caption-text">
    选择正确的数据存储方式
  </p>
</div>


<p><em id="__mceDel"><span style="color: #008000;"><br /> </span></em></p>

<p>当需要存储和读取大量的数据时，该如何选择存储方式呢？</p>

<p>有如下选择：</p>

<ul>
<li>使用<em>NSUserDefaults进行存储</em></li>
<li>保存为XML，JSON或Plist格式的文件</li>
<li>利用NSCoding进行归档</li>
<li>存储到一个本地数据库，例如SQLite。</li>
<li>使用<em>Core Data</em>.</li>
</ul>


<p>使用<em>NSUserDefaults</em>有什么问题呢? 虽然NSUserDefaults很好并且容易，不过只只针对于存储小量数据（比如你的级别，或者声音是开或关）。如果要存储大量的数据，最好选择别的存储方式。</p>

<p>大量数据保存为结构化的文件也可能会带来问题。一般，在解析这些结构数据之前，需要将内容全部加载到内存中，这是很消耗资源的。虽然可以使用SAX来处理XML文件，但是这有点复杂。另外，加载到内存中的所有对象，不一定全部都需要用到。</p>

<p>那么使用NSCoding来保存大量数据怎么样呢？因为它同样是对文件进行读写，因此依然存在上面说的问题。</p>

<p>要保存大量的数据，最好使用SQLite或Core Data。通过SQLite或Core Data可以进行具体的查询——只需要获取并加载需要的数据对象——避免对数据进行不合理的搜索。在性能方面，SQLite和Core Data差不大。</p>

<p>SQLite和Core Data最大的区别实际上就是用法上。Core Data代表一个对象模型，而SQLite只是一个DBMS。一般，苹果建议使用Core Data，不过如果你有特殊的原因不能使用Core Data的话，可以使用低级别的SQLite。</p>

<p>在程序中，如果选择使用SQLite，这里有个方便的库<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://github.com/ccgus/fmdb" target="_blank"><span style="color: #339966; text-decoration: underline;">FMDB</span></a></span></span> ：可以利用该库操作SQLite数据库，而不用深入使用SQLite C API。</p>

<p><span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=180" target="_blank"><span style="color: #339966; text-decoration: underline;">25个增强iOS应用程序性能的提示和技巧 — 初级篇</span></a></span></span><br/>
<span style="text-decoration: underline;"><span style="color: #339966; text-decoration: underline;"><a href="http://beyondvincent.com/?p=263" target="_blank"><span style="color: #339966; text-decoration: underline;">25个增强iOS应用程序性能的提示和技巧 — 高级篇</span></a></span></span></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-06T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 6<span>th</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/raywenderlichfan-yi/'>raywenderlich翻译</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/06/4/" itemprop="url">25个增强iOS应用程序性能的提示和技巧 — 初级篇</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<em><em><strong><br/>
本文由破船译自：<a href="http://www.raywenderlich.com/31166/25-ios-app-performance-tips-tricks" target="_blank">raywenderlich</a><br/>
转载请注明出处：<a href="http://www.beyondvincent.com" target="_blank">BeyondVincent的博客</a><br/>
_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong>_<strong>_</strong></em></em></p>

<p>在开发iOS应用程序时，让程序具有良好的性能是非常关键的。这也是用户所期望的，如果你的程序运行迟钝或缓慢，会招致用户的差评。</p>

<p>然而由于iOS设备的局限性，有时候要想获得良好的性能，是很困难的。在开发过程中，有许多事项需要记住，并且关于性能影响很容易就忘记。</p>

<p>这就是为什么我要写这篇文章！本文收集了25个关于可以提升程序性能的提示和技巧。</p>

<h2><span style="color: #008000;">目录</span></h2>

<p>我把性能优化技巧分为3个不同的等级：初级、<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://beyondvincent.com/?p=258"><span style="color: #339966; text-decoration: underline;">中级</span></a></span></span>和<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://beyondvincent.com/?p=263"><span style="color: #339966; text-decoration: underline;">高级</span></a></span></span>：</p>

<p><span style="color: #008000;"><strong>初级</strong></span></p>

<p>在开发过程中，下面这些初级技巧需要时刻注意：</p>

<ol>
<li><span style="text-decoration: underline; color: #008000;"><a href="#arc"><span style="color: #008000; text-decoration: underline;">使用ARC进行内存管理</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#reuse"><span style="color: #008000; text-decoration: underline;">在适当的情况下使用reuseIdentifier</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#opaque"><span style="color: #008000; text-decoration: underline;">尽可能将View设置为不透明（Opaque）</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#smallxibs"><span style="color: #008000; text-decoration: underline;">避免臃肿的XIBs</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#mainthread"><span style="color: #008000; text-decoration: underline;">不要阻塞主线程</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#imageviews"><span style="color: #008000; text-decoration: underline;">让图片的大小跟UIImageView一样</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#collection"><span style="color: #008000; text-decoration: underline;">选择正确的集合</span></a></span></li>
<li><span style="text-decoration: underline; color: #008000;"><a href="#gzip"><span style="color: #008000; text-decoration: underline;">使用GZIP压缩</span></a></span></li>
</ol>


<p><span style="color: #008000;"><strong> </strong></span></p>

<h2><span style="color: #008000;">初级性能提升</span></h2>

<p>本部分内容介绍几本的程序性能提升技巧。其实所有级别的开发者都能从中获益。</p>

<p><a name="arc"></a><br/>
<span style="color: #008000;">1) 使用ARC进行内存管理</span></p>

<p>ARC是在iOS 5中发布的，它解决了最常见的内存泄露问题——也是开发者最容易健忘的。</p>

<p>ARC的全称是“Automatic Reference Counting”——自动引用计数，它会自动的在代码中做retain/release工作，开发者不用再手动处理。</p>

<p>下面是创建一个View通用的一些代码块：</p>

<pre class="wp-code-highlight prettyprint linenums:1">UIView *view = [[UIView alloc] init];
// ...
[self.view addSubview:view];
[view release];</pre>


<p>在上面代码结束的地方很容易会忘记调用release。不过当使用ARC时，ARC会在后台自动的帮你调用release。</p>

<p>ARC除了能避免内存泄露外，还有助于程序性能的提升：当程序中的对象不再需要的时候，ARC会自动销毁对象。所以，你应该在工程中使用ARC。</p>

<p>下面是一些学习ARC很棒的一些资源：</p>

<ul>
<li><span style="text-decoration: underline; color: #339966;"><a href="https://developer.apple.com/library/ios/#releasenotes/ObjectiveC/RN-TransitioningToARC/Introduction/Introduction.html"><span style="color: #339966; text-decoration: underline;">苹果的官方文档</span></a></span></li>
<li>Matthijs Hollemans的<span style="text-decoration: underline;"><span style="color: #008000; text-decoration: underline;"><a href="http://www.raywenderlich.com/5677/beginning-arc-in-ios-5-part-1"><span style="color: #008000; text-decoration: underline;">初级ARC</span></a></span></span></li>
<li>Tony Dahbura的<span style="text-decoration: underline;"><span style="color: #008000; text-decoration: underline;"><a href="http://www.raywenderlich.com/23854/arc-and-cocos2d-v2-x"><span style="color: #008000; text-decoration: underline;">如何在Cocos2D 2.X工程中使用ARC</span></a></span></span></li>
<li>如果你仍然不确定ARC带来的好处，那么看一些这篇文章：<span style="text-decoration: underline;"><span style="color: #008000; text-decoration: underline;"><a href="http://www.learn-cocos2d.com/2012/06/mythbusting-8-reasons-arc/"><span style="color: #008000; text-decoration: underline;">8个关于ARC的神话</span></a></span></span>——这能够让你相信你应该在工程中使用ARC！</li>
</ul>


<p>值得注意的是，ARC并不能避免所有的内存泄露。使用ARC之后，工程中可能还会有内存泄露，不过引起这些内存泄露的主要原因是：block，retain循环，对CoreFoundation对象（通常是C结构）管理不善，以及真的是代码没写好。</p>

<p>这里有一篇文章是介绍<span style="text-decoration: underline; color: #008000;"><a href="http://conradstoll.com/blog/2013/1/19/blocks-operations-and-retain-cycles.html"><span style="color: #008000; text-decoration: underline;">哪些问题是ARC不能解决的</span></a></span> — 以及如何处理这些问题。</p>

<p><a name="reuse"></a><br/>
<span style="color: #008000;">2) 在适当的情况下使用reuseIdentifier</span></p>

<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn2.raywenderlich.com/wp-content/uploads/2013/03/ReuseIdentifier.png" target="_blank"><img class=" " alt="" src="http://cdn2.raywenderlich.com/wp-content/uploads/2013/03/ReuseIdentifier.png" width="250" height="225" /></a><p class="wp-caption-text">
    在适当的情况使用reuseIdentifier
  </p>
</div>


<p>在iOS程序开发中一个普遍性的错误就是没有正确的为UITableViewCells、UICollectionViewCells和UITableViewHeaderFooterViews设置reuseIdentifier。</p>

<p>为了获得最佳性能，当在tableView:cellForRowAtIndexPath:方法中返回cell时，table view的数据源一般会重用UITableViewCell对象。table view维护着UITableViewCell对象的一个队列或者列表，这些数据源已经被标记为重用了。</p>

<p>如果没有使用reuseIdentifier会发生什么？</p>

<p>如果你在程序中没有使用reuseIdentifier，table view每次显示一个row时，都会配置一个全新的cell。这其实是一个非常消耗资源的操作，并且会影响程序中table view滚动的效率。</p>

<p>自iOS 6以来，你可能还希望header和footer views，以及UICollectionView的cell和supplementary views。</p>

<p>为了使用reuseIdentifiers，在table view请求一个新的cell时，在数据源中调用下面的方法：</p>

<pre class="wp-code-highlight prettyprint linenums:1">static NSString *CellIdentifier = @"Cell";
UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier forIndexPath:indexPath];</pre>


<p>如果table view维护的UITableViewCell队列或列表中有可用的cell，则从队列从移除一个已经存在的cell，如果没有的话，就从之前注册的nib文件或类中创建一个新的cell。如果没有可以重用的cell，并且没有注册nib文件或类，tableview的dequeueReusableCellWithIdentifier:方法会返回一个nil。</p>

<p><a name="opaque"></a><br/>
<span style="color: #008000;">3) 尽可能将View设置为不透明（Opaque）</span></p>

<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn1.raywenderlich.com/wp-content/uploads/2013/03/Opaque.png"><img alt="" src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/03/Opaque.png" width="250" height="207" /></a><p class="wp-caption-text">
    尽量将view设置为Opaque
  </p>
</div>


<p>&nbsp;</p>

<p>如果view是不透明的，那么应该将其opaque属性设置为YES。</p>

<p>为什么要这样做呢？这样设置可以让系统以最优的方式来绘制view。opaque属性可以在Interface Builder或代码中设置。</p>

<p><span style="text-decoration: underline; color: #339966;"><a href="http://developer.apple.com/library/ios/#documentation/UIKit/Reference/UIView_Class/UIView/UIView.html"><span style="color: #339966; text-decoration: underline;">苹果的官方文档</span></a></span>对opaque属性有如下解释：</p>

<p><span style="color: #808080;"><em>This property provides a hint to the drawing system as to how it should treat the view. If set to YES, the drawing system treats the view as fully opaque, which allows the drawing system to optimize some drawing operations and improve performance. If set to NO, the drawing system composites the view normally with other content. The default value of this property is YES.</em></span></p>

<p><span style="color: #808080;"><em>（opaque属性提示绘制系统如何处理view。如果opaque设置为YES，绘图系统会将view看为完全不透明，这样绘图系统就可以优化一些绘制操作以提升性能。如果设置为NO，那么绘图系统结合其它内容来处理view。默认情况下，这个属性是YES。）</em></span></p>

<p>&nbsp;</p>

<p>如果屏幕是静止的，那么这个opaque属性的设置与否不是一个大问题。但是，如果view是嵌入到scroll view中的，或者是复杂动画的一部分，不将设置这个属性的话肯定会影响程序的性能！</p>

<p>可以通过模拟器的Debug\Color Blended Layers选项来查看哪些view没有设置为不透明。为了程序的性能，尽可能的将view设置为不透明！</p>

<p>&nbsp;</p>

<p><a name="smallxibs"></a><br/>
<span style="color: #008000;">4) 避免臃肿的XIBs</span></p>

<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn1.raywenderlich.com/wp-content/uploads/2013/03/FatXIB.png"><img alt="" src="http://cdn1.raywenderlich.com/wp-content/uploads/2013/03/FatXIB.png" width="250" height="187" /></a><p class="wp-caption-text">
    避免臃肿的XIBs
  </p>
</div>


<p>&nbsp;</p>

<p>在iOS 5中开始使用Storyboards，并且将替代XIBs。不过在有些情况下XIBs仍然有用。如果你的程序需要运行在装有iOS 5之前版本的设备上，或者要自定义可重用的view，那么是避免不了要使用XIBs的。</p>

<p>如果必须要使用XIBs的话，尽量让XIBs文件简单。并且每个view controller对于一个XIB文件，如果可以的话，把一个view controller的view不同的层次单独分到一个XIBs文件中。</p>

<p>注意：当把一个XIB文件加载到内存时，XIB文件中的所有内容都将被加载到内存中，包括图片。如果有一个view还不立即使用的话，就会造成内存的浪费。而这在storyboard中是不会发生的，因为storyboard还在需要的时候才实例化一个view controller。</p>

<p>当加载XIB时，所有涉及到的图片都将被缓存，并且如果是开发的程序是针对OS X的话，声音文件也会被加载。<span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://developer.apple.com/library/ios/#documentation/Cocoa/Conceptual/LoadingResources/CocoaNibs/CocoaNibs.html"><span style="color: #339966; text-decoration: underline;">苹果的官方文档</span></a></span></span>这样说：</p>

<p><span style="color: #999999;"><em>When you load a nib file that contains references to image or sound resources, the nib-loading code reads the actual image or sound file into memory and and caches it. In OS X, image and sound resources are stored in named caches so that you can access them later if needed. In iOS, only image resources are stored in named caches. To access images, you use the imageNamed: method of NSImage or UIImage, depending on your platform.</em></span></p>

<p><span style="color: #999999;"><em>（当加载一个nib文件时，也会将nib文件涉及到的图片或声音资源加载到内存中，nib-loading代码会将实际的图片或声音文件读取到内存中，并一直缓存着。在OS X中，图片和声音资源都存储在命名缓存中，这样之后如果需要的话，可以对其进行访问。在iOS中，只有图片资源被存储到命名缓存中。要访问图片的话，使用<em>NSImage或UIImage（根据不同的系统）的imageNamed:方法即可。</em>）</em></span></p>

<p>显然，在使用storyboard时也会发生类似的缓存操作；不过我没有找到相关内容的任何资料。如果你知道的话，可以告诉我哦！</p>

<p>想要学习storyboard的更多知识吗？可以看看Matthijs Hollemans写的iOS 5中：<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://www.raywenderlich.com/5138/beginning-storyboards-in-ios-5-part-1"><span style="color: #339966; text-decoration: underline;">初级Storyboard Part 1</span></a></span></span>和<span style="text-decoration: underline; color: #339966;"><a href="http://www.raywenderlich.com/5191/beginning-storyboards-in-ios-5-part-2"><span style="text-decoration: underline; color: #339966;">Part2</span></a></span>。<br/>
<a name="mainthread"></a><br/>
<span style="color: #008000;">5) 不要阻塞主线程</span></p>

<div class="wp-caption alignright" style="width: 240px">
  <a href="http://cdn3.raywenderlich.com/wp-content/uploads/2013/03/RainbowWheel.jpg"><img alt="" src="http://cdn3.raywenderlich.com/wp-content/uploads/2013/03/RainbowWheel.jpg" width="230" height="230" /></a><p class="wp-caption-text">
    不要阻塞主线程
  </p>
</div>


<p>&nbsp;</p>

<p>永远都不要在主线程做繁重的任务。因为UIKit的任务都在主线程中进行，例如绘制、触摸管理和输入响应。</p>

<p>在主线程做所有任务的风险是：如果你的代码阻塞了主线程，那么程序将出现反应迟钝。这回招致用户在App Store上对程序的差评！</p>

<p>在执行I/O操作中，大多数情况下都会祖塞主线程，这些操作需要从读写外部资源，例如磁盘或者网络。</p>

<p>关于网络操作可以使用NSURLConnection的如下方法，以异步的方式来执行：</p>

<pre class="wp-code-highlight prettyprint linenums:1">+ (void)sendAsynchronousRequest:(NSURLRequest *)request queue:(NSOperationQueue *)queue completionHandler:(void (^)(NSURLResponse*, NSData*, NSError*))handler</pre>


<p>或者使用第三方框架，例如<span style="text-decoration: underline; color: #339966;"><a href="http://www.raywenderlich.com/30445/afnetworking-crash-course"><span style="color: #339966; text-decoration: underline;">AFNetworking</span></a></span>。</p>

<p>如果你需要做一些其它类型开销很大的操作（例如执行一个时间密集型的计算或者对磁盘进行读写），那么就使用GCD（Grand Central Dispatch），或NSOperations 和 NSOperationQueues。</p>

<p>下面的代码是使用GCD的一个模板：</p>

<pre class="wp-code-highlight prettyprint linenums:1">dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    // switch to a background thread and perform your expensive operation

    dispatch_async(dispatch_get_main_queue(), ^{
        // switch back to the main thread to update your UI

    });
});</pre>


<p>如上代码，为什么在第一个<strong>dispatch_async</strong>里面还嵌套了一个dispatch_async呢？这是因为关于UIKit相关的代码需要在主线程里面执行。</p>

<p>对<strong>NSOperation</strong>和<strong>GCD</strong>感到好奇吗？可以看看Ray Wenderlich中的教程：<span style="text-decoration: underline; color: #339966;"><a href="http://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial"><span style="color: #339966; text-decoration: underline;">iOS中多线程和GCD—初级</span></a></span>，以及Soheil Azarpour的<span style="text-decoration: underline; color: #339966;"><a href="http://www.raywenderlich.com/19788/how-to-use-nsoperations-and-nsoperationqueues"><span style="color: #339966; text-decoration: underline;">如何使用NSOperations和NSOperationQueues教程</span></a></span>。</p>

<p>&nbsp;</p>

<p><a name="imageviews"></a><br/>
<span style="color: #008000;">6) 让图片的大小跟UIImageView一样</span></p>

<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/03/ImageViews.png"><img alt="" src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/03/ImageViews.png" width="250" height="192" /></a><p class="wp-caption-text">
    确保图片和UIImageView大小一致
  </p>
</div>


<p>如果需要将程序bundle中的图片显示到UIImageView中，请确保图片和UIImageView的大小是一样的。因为图片的缩放非常耗费资源，特别是将UIImageView嵌入到UIScrollView中。</p>

<p>如果是从远程服务中下载图片，有时候你控制不了图片的尺寸，或者在下载之前无法在服务器上进行图片的缩放。这种情况，当图片下载完之后，你可以手动进行图片的缩放——做好是在后台线程中！——然后再在UIImageView中使用缩放过的图片。</p>

<p>&nbsp;</p>

<p><a name="collection"></a><br/>
<span style="color: #008000;">7) 选择正确的集合</span></p>

<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn4.raywenderlich.com/wp-content/uploads/2013/03/Collections.png"><img alt="" src="http://cdn4.raywenderlich.com/wp-content/uploads/2013/03/Collections.png" width="250" height="211" /></a><p class="wp-caption-text">
    选择正确的集合
  </p>
</div>


<p>学习使用最适合的类或对象是编写高效代码的基础。特别是在处理集合数据时，尤为重要。</p>

<p>苹果的官网上有一篇文章：<span style="text-decoration: underline; color: #339966;"><a href="https://developer.apple.com/library/ios/#documentation/cocoa/conceptual/collections/Collections.html"><span style="color: #339966; text-decoration: underline;">集合编程主题(Collections Programming Topics)</span></a></span>——详细的介绍了在集合数据中可以使用的类，以及什么情况下使用哪个类。在使用集合时，每个开发者都应该阅读一下这个文档。</p>

<p>太长，不想阅读(TLDR)？下面是常见集合类型的一个简介：</p>

<ul>
<li><span style="color: #339966;"><strong>数组<span style="color: #000000;">：</span></strong><span style="color: #000000;">是一个</span></span>值按顺序排列的一个列表。根据索引可以快速查找，不过根据值进行查找就比较慢，另外插入和删除也比较慢。</li>
<li><span style="color: #339966;"><strong>字典</strong>:</span>  存储键/值对。根据键可以快速查找。</li>
<li><span style="color: #339966;"><strong>Sets</strong></span>:  是一个值无序排列的列表，根据值可以快速查找，另外插入和删除也比较快。</li>
</ul>


<p><a name="gzip"></a><br/>
<span style="color: #008000;">8) 使用GZIP压缩</span></p>

<div class="wp-caption alignright" style="width: 260px">
  <a href="http://cdn5.raywenderlich.com/wp-content/uploads/2013/03/Gnu_gzip_logo.png"><img alt="" src="http://cdn5.raywenderlich.com/wp-content/uploads/2013/03/Gnu_gzip_logo.png" width="250" height="166" /></a><p class="wp-caption-text">
    使用GZIP压缩
  </p>
</div>


<p>越来越多的程序依赖于外部数据，这些数据一般来自远程服务器或者其它的外部APIs。有时候你需要开发一个程序来下载一些数据，这些数据可以是XML，JSON，HTML或者其它一些文本格式。</p>

<p>问题是在移动设备上的网络是不确定的。用户的设备可能在EDGE网络一分钟，然后接着又在3G网络中。不管在什么情况下，都不要让用户等待。</p>

<p>有一个可以优化的选择：使用GZIP对网络传输中的数据进行压缩，这样可以减小文件的大小，并加快下载的速度。压缩对于文本数据特别有用，因为文本具有很高的压缩比。</p>

<p>iOS中，如果使用NSURLConnection，那么默认情况下已经支持GZIP压缩了，并且基于NSURLConnection的框架页支持GZIP压缩，如<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://www.raywenderlich.com/30445/afnetworking-crash-course" target="_blank"><span style="color: #339966; text-decoration: underline;">AFNetworking</span></a></span></span>。甚至有些云服务提供商已经提供发送经压缩过的响应内容，例如 <span style="text-decoration: underline;"><span style="color: #339966;"><a href="https://developers.google.com/appengine/" target="_blank"><span style="color: #339966; text-decoration: underline;">Google App Engine</span></a></span></span>。</p>

<p>这里有<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://betterexplained.com/articles/how-to-optimize-your-site-with-gzip-compression/"><span style="color: #339966; text-decoration: underline;">一篇关于GZIP压缩很好的文章</span></a></span></span>，介绍了如何在Apache活IIS服务器中开启支持GZIP压缩。</p>

<p>&nbsp;</p>

<p><span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://beyondvincent.com/?p=258" target="_blank"><span style="color: #339966; text-decoration: underline;">25个增强iOS应用程序性能的提示和技巧 — 中级篇</span></a></span></span><br/>
<span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://beyondvincent.com/?p=263" target="_blank"><span style="color: #339966; text-decoration: underline;">25个增强iOS应用程序性能的提示和技巧 — 高级篇</span></a></span></span><span style="text-decoration: underline;"><span style="color: #339966;"><a href="http://beyondvincent.com/?p=180" target="_blank"><span style="color: #339966; text-decoration: underline;"><br /> </span></a></span></span></p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2013-04-03T00:00:00+08:00" data-updated="true" itemprop="datePublished">Apr 3<span>rd</span>, 2013</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/raywenderlichfan-yi/'>raywenderlich翻译</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2013/04/03/3/" itemprop="url">iOS中如何利用GDataXML对XML文档进行读写</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>&nbsp;</p>

<p>&nbsp;</p>

<p><img class="alignright" style="margin: 12px 0px 12px 24px;" title="Let's read and write this!" alt="Let's read and write this!" src="http://cdn3.raywenderlich.com/wp-content/uploads/2010/03/XMLDocument.jpg" width="250" height="122" /></p>

<p>在上一篇文章：<a href="http://beyondvincent.com/?p=62">在iOS工程中如何选择最佳的XML解析器</a>中，Saliom建议我写一篇文章介绍一下如何使用XML解析器来读写XML文档，并根据XML文档创建自己的对象，以及执行XPath查询。</p>

<p>本文我就告诉你该如何去做！我将创建一个工程，来读取XML示例文档中的内容（包含RPG玩家列表），并基于该XML文档构建我们自己的对象。接着我将在成员列表中添加一个新的玩家，然后再将其保存回磁盘中。</p>

<p>这里我使用的是GDataXML — Google解析XML的一个库。之所选择GDataXML是因为它针对DOM解析的执行效率不错，并且支持XML文档的读写，也很容易集成到工程中。当然，如果你使用别的DOM解析器，大多数操作都是一样的，只不过API的调用有轻微的不同。</p>

<p>特别感谢Saliom建议我写这篇文章！</p>

<h2>我的XML文档</h2>

<p>下图是我在本文中使用到的XML文档示例：</p>

<p><a href="http://www.raywenderlich.com/725/how-to-read-and-write-xml-documents-with-gdataxml/screenshot1-4" rel="attachment wp-att-727"><img title="Screenshot of our XML document" alt="Screenshot of our XML document" src="http://cdn1.raywenderlich.com/wp-content/uploads/2010/03/Screenshot13.jpg" width="217" height="305" /></a></p>

<p>之前我提到过，上面的这个列表代表了一个RPG游戏中玩家。这里我尽量让XML数据简洁，当然，我还添加了一些有趣的数据。</p>

<p>OK，下面我们就开始在工程中对该XML文档内容进行读写吧！</p>

<h2>集成GDataXML</h2>

<p>按照下面的步骤，就可以把GDataXML集成到新的工程中：</p>

<ul>
<li>选择Project\New Project, 然后选择View-based Application, 将工程命名为XMLTest。</li>
<li>下载<a href="http://code.google.com/p/gdata-objectivec-client/downloads/list">gdata-objective-c client library</a>。</li>
<li>解压下载的文件，定位到Source\XMLSupport, 然后将GDataXMLNode.h 和 GDataXMLNode.m两个文件拖入工程中。</li>
<li>在XCode中, 点击Project\Build Settings 并确保 “All”选中。</li>
<li>找到Search Paths\Header Search Paths并添加/usr/include/libxml2。</li>
<li>然后，找到Linking\Other Linker Flags并添加-lxml2到列表中。</li>
<li>在 XMLTestAppDelegate.h的顶部添加如下代码，可以测试上面的步骤是否正确：</li>
</ul>


<pre class="wp-code-highlight prettyprint linenums:1">#import "GDataXMLNode.h"</pre>


<p>如果程序能够编译并运行，说明GDataXML集成成功了！</p>

<h2>创建模型类</h2>

<p>下一步，我们创建一组模型类来代表XML文档中的玩家。</p>

<p>首先创建一个Player类。点击File\New File, 选择Cocoa Touch\Objective-C class, 点击Next之后，选择Subclass of NSObject, 然后在点击Next，将文件命名为Player。</p>

<p>然后用下面的代码替换Player.h文件:</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import &lt;Foundation/Foundation.h&gt;

typedef enum {
    RPGClassFighter,
    RPGClassRogue,
    RPGClassWizard
} RPGClass;

@interface Player : NSObject {
    NSString *_name;
    int _level;
    RPGClass _rpgClass;
}

@property (nonatomic, copy) NSString *name;
@property (nonatomic, assign) int level;
@property (nonatomic, assign) RPGClass rpgClass;

- (id)initWithName:(NSString *)name level:(int)level rpgClass:(RPGClass)rpgClass;

@end</pre>


<p>接着用下面的代码替换Player.m文件:</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import "Player.h"

@implementation Player
@synthesize name = _name;
@synthesize level = _level;
@synthesize rpgClass = _rpgClass;

- (id)initWithName:(NSString *)name level:(int)level rpgClass:(RPGClass)rpgClass {Class:(RPGClass)rpgClass {

    if ((self = [super init])) {
        self.name = name;
        self.level = level;
        self.rpgClass = rpgClass;
    }    
    return self;

}

- (void) dealloc {
    self.name = nil;    
    [super dealloc];
}

@end</pre>


<p>上面所涉及到的都是Objective-C, 现在没有真正的涉及到XML。为了完整性，这里我将其全部列出来。<br/>
按照上面创建一个NSObject子类的步骤，在创建一个名为Party的类。然后用下面的代码替换Party.h文件:</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import &lt;Foundation/Foundation.h&gt;

@interface Party : NSObject {
NSMutableArray *_players;
}

@property (nonatomic, retain) NSMutableArray *players;

@end
And Party.m with the following:
#import "Party.h"

@implementation Party
@synthesize players = _players;

- (id)init {

if ((self = [super init])) {
self.players = [[[NSMutableArray alloc] init] autorelease];
}
return self;

}

- (void) dealloc {
self.players = nil;
[super dealloc];
}

@end</pre>


<p>下面我们开始解析XML文件，并创建基于XML文件内容的实例对象。</p>

<h2>使用GDataXML解析XML</h2>

<p>下面我们使用GDataXML来读取XML文档内容，并在内存中创建一棵DOM树。</p>

<p>首先，下载<a href="http://d1xzuxjlafny7l.cloudfront.net/downloads/Party.xml">Party.xml</a>文件，并将其添加到工程中。</p>

<p>接着，创建一个新的类，里面包含了所有相关解析的代码。在工程中添加一个名为PartyParser的新类，该类继承自NSObject</p>

<p>用下面的代码替换PartyParser.h文件:</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import &lt;Foundation/Foundation.h&gt;

@class Party;

@interface PartyParser : NSObject {

}

+ (Party *)loadParty;

@end</pre>


<p>然后用下面的代码替换PartyParser.m文件：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import "PartyParser.h"
#import "Party.h"
#import "GDataXMLNode.h"
#import "Player.h"

@implementation PartyParser

+ (NSString *)dataFilePath:(BOOL)forSave {
    return [[NSBundle mainBundle] pathForResource:@"Party" ofType:@"xml"];
}

+ (Party *)loadParty {

    NSString *filePath = [self dataFilePath:FALSE];
    NSData *xmlData = [[NSMutableData alloc] initWithContentsOfFile:filePath];
    NSError *error;
    GDataXMLDocument *doc = [[GDataXMLDocument alloc] initWithData:xmlData 
        options:0 error:&amp;error];
    if (doc == nil) { return nil; }

    NSLog(@"%@", doc.rootElement);

    [doc release];
    [xmlData release];
    return nil;

}</pre>


<p>@end</p>

<p>上面的代码中，我首先创建了一个静态方法dataFilePath，该方法返回添加到工程中（成为程序bundle的一部分）Party.xml文件的路径。注意，该方法有一个boolean参数值，表示我们对该路径中的文件进行读或写—现在还不使用，稍后会用到。</p>

<p>接着，我创建了另外一个静态方法loadParty。该方法会使用NSMutableData的initWithContentsOfFile方法将粗盘中文件的内容以字节的形式加载到内存中，然后将数据传递给GDataXML解析器(通过GDataXMLDocument的initWithData方法)。</p>

<p>如果GDataXML在解析文件过程中遇到了错误（比如缺少结束标记），那么会返回nil和一个NSError对象，该对象有相关错误信息。本文中，如果发生了错误，我只返回一个nil。</p>

<p>在上面的代码中，如果解析成功，我将把XML文档的root元素打印出来。</p>

<p>下面，我们就来使用上面这个方法吧。将XMLTestAppDelegate.h文件按照如下修改：</p>

<pre class="wp-code-highlight prettyprint linenums:1">#import "XMLTestAppDelegate.h"
#import "XMLTestViewController.h"
#import "PartyParser.h"
#import "Party.h"
#import "Player.h"

@implementation XMLTestAppDelegate

@synthesize window;
@synthesize viewController;
@synthesize party = _party;

- (void)applicationDidFinishLaunching:(UIApplication *)application {    

    self.party = [PartyParser loadParty];    

    // Override point for customization after app launch    
    [window addSubview:viewController.view];
    [window makeKeyAndVisible];
}

- (void)dealloc {
    self.party = nil;
    [viewController release];
    [window release];
    [super dealloc];
}

@end</pre>


<p>在上面的代码中，我只是import了几个文件，并在applicationDidFinishLaunching方法中调用之前定义的静态方法以加载party，另外在dealloc方法中做了一些清除任务。</p>

<p>现在编译并运行程序，通过Run\Console，并滚到Console窗口底部，将看到类似如下的一些信息：</p>

<pre class="wp-code-highlight prettyprint linenums:1">2010-03-17 11:31:21.467 XMLTest[1568:207] GDataXMLElement 0x3b02530: 
{type:1 name:Party xml:"Butch
1Fighter
Shadow2Rogue
Crak3
Wizard"}</pre>


<h2>将XML转换为模型对象</h2>

<p>从上面的介绍中，我们可以看到解析器已经开始起作用了，下面我们继续解析整棵DOM树，并创建出我们的模型对象。</p>

<p>将loadParty方法中从NSLog语句开始处，用下面的代码进行替换：</p>

<pre class="wp-code-highlight prettyprint linenums:1">Party *party = [[[Party alloc] init] autorelease];
NSArray *partyMembers = [doc.rootElement elementsForName:@"Player"];
for (GDataXMLElement *partyMember in partyMembers) {

    // Let&#039;s fill these in!
    NSString *name;
    int level;
    RPGClass rpgClass;

    // Name
    NSArray *names = [partyMember elementsForName:@"Name"];
    if (names.count &gt; 0) {
        GDataXMLElement *firstName = (GDataXMLElement *) [names objectAtIndex:0];
        name = firstName.stringValue;
    } else continue;

    // Level
    NSArray *levels = [partyMember elementsForName:@"Level"];
    if (levels.count &gt; 0) {
        GDataXMLElement *firstLevel = (GDataXMLElement *) [levels objectAtIndex:0];
        level = firstLevel.stringValue.intValue;
    } else continue;

    // Class
    NSArray *classes = [partyMember elementsForName:@"Class"];
    if (classes.count &gt; 0) {
        GDataXMLElement *firstClass = (GDataXMLElement *) [classes objectAtIndex:0];
        if ([firstClass.stringValue caseInsensitiveCompare:@"Fighter"] 
            == NSOrderedSame) {
            rpgClass = RPGClassFighter;
        } else if ([firstClass.stringValue caseInsensitiveCompare:@"Rogue"] 
            == NSOrderedSame) {
            rpgClass = RPGClassRogue;
        } else if ([firstClass.stringValue caseInsensitiveCompare:@"Wizard"] 
            == NSOrderedSame) {
            rpgClass = RPGClassWizard;
        } else {
            continue;
        }            
    } else continue;

    Player *player = [[[Player alloc] initWithName:name level:level 
            rpgClass:rpgClass] autorelease];
    [party.players addObject:player];

}

[doc release];
[xmlData release];
return party;</pre>


<p>在上面的代码中，我在root节点上使用GDataXMLElement的elementsForName方法来获取“Party”节点下所有名称为“Player”的节点。</p>

<p>然后，在每个“Player”节点下，我都会去查找“Name节点素。上面的代码中只处理一个名字，所以，如果有多于一个以上的名字，那么我只会去第一个。</p>

<p>同样，针对“Level”和“Class”节点，也做相同的处理，只不过我会把level从字符串转换为一个整型，class转换为枚举。</p>

<p>操作过程中，如果失败了，那么只是忽略掉Player。如果，一切正确的话，那么我将根据从XML中读取出来的数据创建一个Player对象，并将其添加到Party中，最后将Party返回！</p>

<p>下面，我们就来看看上面的方法是否正确。将下面的代码添加到XMLTestAppDelegate.m文件中applicationDidFinishLaunching方法里面的loadParty调用后面：</p>

<pre class="wp-code-highlight prettyprint linenums:1">if (_party != nil) {
    for (Player *player in _party.players) {
        NSLog(@"%@", player.name);
    }
}</pre>


<p>编译并运行程序，如果一切正常的话，可以在控制台看到如下内容：</p>

<pre class="wp-code-highlight prettyprint linenums:1">2010-03-17 12:33:04.301 XMLTest[2531:207] Butch
2010-03-17 12:33:04.303 XMLTest[2531:207] Shadow
2010-03-17 12:33:04.304 XMLTest[2531:207] Crak</pre>


<h2>使用XPath进行查询</h2>

<p>XPath是一种简单的语法，可以用来查询XML文档中的内容。掌握XPath的最佳方法就是通过一些示例。</p>

<p>例如，下面的XPath表达式是用来查询XML文档中所有的Player节点：</p>

<pre class="wp-code-highlight prettyprint linenums:1">//Party/Player</pre>


<p>而下面的表达式则是查询出XML文档中第一个Player节点：</p>

<pre class="wp-code-highlight prettyprint linenums:1">//Party/Player[1]</pre>


<p>最后，下面这个表达式则是查询出名字为Shadow的Player节点：</p>

<pre class="wp-code-highlight prettyprint linenums:1">//Party/Player[Name="Shadow"]</pre>


<p>下面我们稍微的修改一下loadParty方法，来看看如何使用XPath。替换一下加载party的代码，如下所示：</p>

<pre class="wp-code-highlight prettyprint linenums:1">//NSArray *partyMembers = [doc.rootElement elementsForName:@"Player"];
NSArray *partyMembers = [doc nodesForXPath:@"//Party/Player" error:nil];</pre>


<p>如果现在运行程序，会看到跟之前一样的结果。其实这并不是XPath的一个优点，因为在这里我们是要读取出XML文档中所有内容，并在内存中构造一个数据模型。</p>

<p>不过，你可以想象一下，如果这里有一个大的，很复杂的XML文档，我们希望迅速的找到指定的节点，但是并不是通过查找A的子节点，然后是B的子节点，直到找到指定节点，那么此时，XPath将非常有用。</p>

<p>如果你对XPath感兴趣的话，可以从<a href="http://www.w3schools.com/XPath/xpath_intro.asp">W2Schools的教程</a>里学到更多相关内容。同样，这里我还发现一个<a href="http://www.whitebeam.org/library/guide/TechNotes/xpathtestbed.rhtm">在线测试XPath表达式的一个网站</a>，非常方便。</p>

<h2>保存回XML</h2>

<p>到现在为止，我们只完成了一半的任务：从XML文档中读取出数据。如果我们想要添加新的player，并将新的文档保存回磁盘中，该如何操作呢？</p>

<p>首先，我们需要做的事情是确定一下将XML文档保存到哪里。之前，我们已经从程序的bundle中加载XML文档了，不过，那是只读的。不过，我们可以将其保存到程序的document目录中。下面就来试试吧。</p>

<p>修改一下PartyParser.m文件中的dataFilePath方法，如下代码：</p>

<pre class="wp-code-highlight prettyprint linenums:1">+ (NSString *)dataFilePath:(BOOL)forSave {

    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, 
        NSUserDomainMask, YES);
    NSString *documentsDirectory = [paths objectAtIndex:0];
    NSString *documentsPath = [documentsDirectory
        stringByAppendingPathComponent:@"Party.xml"];
    if (forSave || 
        [[NSFileManager defaultManager] fileExistsAtPath:documentsPath]) {
        return documentsPath;
    } else {
        return [[NSBundle mainBundle] pathForResource:@"Party" ofType:@"xml"];
    }

}</pre>


<p>注意，在加载XML时，如果document目录中存在XML文件，那么就从document中加载，否则就从程序的bundle中加载。</p>

<p>下面，我来写一个方法：根据我们的数据模型来构造一个XML文档，并将其保存到磁盘中。如下代码，将新方法添加到PartyParser.m文件中:</p>

<pre class="wp-code-highlight prettyprint linenums:1">+ (void)saveParty:(Party *)party {

    GDataXMLElement * partyElement = [GDataXMLNode elementWithName:@"Party"];

    for(Player *player in party.players) {

        GDataXMLElement * playerElement = 
            [GDataXMLNode elementWithName:@"Player"];
        GDataXMLElement * nameElement = 
            [GDataXMLNode elementWithName:@"Name" stringValue:player.name];
        GDataXMLElement * levelElement = 
            [GDataXMLNode elementWithName:@"Level" stringValue:
                [NSString stringWithFormat:@"%d", player.level]];
        NSString *classString;
        if (player.rpgClass == RPGClassFighter) {
            classString = @"Fighter";
        } else if (player.rpgClass == RPGClassRogue) {
            classString = @"Rogue";
        } else if (player.rpgClass == RPGClassWizard) {
            classString = @"Wizard";
        }        
        GDataXMLElement * classElement = 
            [GDataXMLNode elementWithName:@"Class" stringValue:classString];

        [playerElement addChild:nameElement];
        [playerElement addChild:levelElement];
        [playerElement addChild:classElement];
        [partyElement addChild:playerElement];
    }

    GDataXMLDocument *document = [[[GDataXMLDocument alloc] 
            initWithRootElement:partyElement] autorelease];
    NSData *xmlData = document.XMLData;

    NSString *filePath = [self dataFilePath:TRUE];
    NSLog(@"Saving xml data to %@...", filePath);
    [xmlData writeToFile:filePath atomically:YES];

}</pre>


<p>如上代码所示，使用GDataXML来构造XML文档非常的简单和直接。通过elementWithName:或elementWithName:stringValue方法就可以创建节点，并通过addChild就能把这些节点关联起来，然后根据指定的根节点就可以创建一个GDataXMLDocument。最后，获得相关的NSData，并将其保存到磁盘中。</p>

<p>下面，在PartyParser.h文件中声明这个新方法：</p>

<pre class="wp-code-highlight prettyprint linenums:1">+ (void)saveParty:(Party *)party;</pre>


<p>然后在applicationDidFinishLaunching中做一下判断：party != nil，并在列表中添加一个新的玩家：</p>

<pre class="wp-code-highlight prettyprint linenums:1">[_party.players addObject:[[[Player alloc] initWithName:@"Waldo" level:1 
    rpgClass:RPGClassRogue] autorelease]];</pre>


<p>最后applicationWillTerminate方法中将更新的玩家列表保存起来：</p>

<pre class="wp-code-highlight prettyprint linenums:1">- (void)applicationWillTerminate:(UIApplication *)application {
    [PartyParser saveParty:_party];   
}</pre>


<p>编译并运行程序，程序加载完毕之后，退出程序。程序将会打印出XML文件保存的位置。如下：</p>

<pre class="wp-code-highlight prettyprint linenums:1">2010-03-17 13:34:14.447 XMLTest[3118:207] Saving xml data to 
/Users/rwenderlich/Library/Application Support/iPhone Simulator/User/
Applications/BF246A72-7E20-47CF-93FF-AA2CEF50A6B0/Documents/Party.xml..</pre>


<p>接着通过Finder找到对应的文件夹，并打开XML文件，如果一切正常的话，在XML文件中已经新增了一个玩家：</p>

<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2010/03/Screenshot24.jpg" alt="Screenshot of our Modified XML" /></p>

<p>然后在运行一次程序，并打开控制台窗口，你将看到Waldo玩家！:]</p>

<h2>总结</h2>

<p>这里是本文的<a href="http://d1xzuxjlafny7l.cloudfront.net/downloads/XMLTest.zip">示例代码</a>。注意，该程序不会在GUI中显示任何内容（这并不重要）——只是在控制台显示一些内容。</p>

<p>另外 — 在工程中使用XML之前，应该花点时间考虑一下，为什么要在工程中使用XML，这是最佳选择吗。在这里的示例中，如果我们只是加载和保存一些数据，使用XML可能是大材小用了，使用别的一些序列化格式可能会更好：例如plist，NSCoding或者Core Data。</p>

<p>不过，在多个程序中都使用相同的数据，那么XML是个不错的选择。如果我们用Mac程序生成了一个列表数据，而我们希望iPhone程序能够对该列表进行读写，那么XML将非常有用。这也是为什么XML是数据交换的标准格式（非常容易协同利用）。</p>

<p>至此，在写程序的时候，你计划使用XML了吗？</p>

<p align="right">
  本文由破船译自：<a href="http://www.raywenderlich.com/725/how-to-read-and-write-xml-documents-with-gdataxml">raywenderlich</a>
</p>


<hr />

<p align="right">
  <span style="color: #a5a5a5;">2008 大连 星海湾</span>
</p>




<div class="wlWriterEditableSmartContent" id="scid:8747F07C-CDE8-481f-B0DF-C6CFD074BF67:301dcbd3-4cc4-40f0-b1eb-4b1bf95ca910" style="float: none; margin: 0px; display: inline; padding: 0px;">
  <a title="2008 大连 星海湾" href="http://beyondvincent.com/wp-content/uploads/2013/04/psu-8x6.jpg" rel="thumbnail"><img alt="" src="http://beyondvincent.com/wp-content/uploads/2013/04/psu1.png" width="642" height="560" border="0" /></a>
</div>




		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="/blog/page/10/" class="prev">Prev</a>
    
    
        <a href="/blog/page/12/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">所有文章</a></div>
    
    <script type="text/javascript">
var duoshuoQuery = {short_name:"beyondvincent"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
</nav>

</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2013 - 破船(BeyondVincent) -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'beyondvincent001';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-42893468-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>





<script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F1a3c98825a726bfbf68a83ba97e0b9be' type='text/javascript'%3E%3C/script%3E"));
    </script>

		</div>
	</div>
</body>
</html>
